--
-- XC_ALTER_TABLE
--
-- Check on dropped columns
CREATE TABLE xc_alter_table_1 (id serial, name varchar(80), code varchar(80)) DISTRIBUTE BY HASH(id);
EXPLAIN (VERBOSE true, COSTS false, NODES false) INSERT INTO xc_alter_table_1(name) VALUES ('aaa'),('bbb'),('ccc');
                                                  QUERY PLAN                                                   
---------------------------------------------------------------------------------------------------------------
 Insert on public.xc_alter_table_1
   ->  Values Scan on "*VALUES*"
         Output: nextval('xc_alter_table_1_id_seq'::regclass), "*VALUES*".column1, NULL::character varying(80)
(3 rows)

INSERT INTO xc_alter_table_1(name) VALUES ('aaa'),('bbb'),('ccc');
SELECT id, name, code FROM xc_alter_table_1 ORDER BY 1;
 id | name | code 
----+------+------
  1 | aaa  | 
  2 | bbb  | 
  3 | ccc  | 
(3 rows)

-- Drop 1st column
ALTER TABLE xc_alter_table_1 DROP COLUMN code;
-- Check for query generation of remote INSERT
INSERT INTO xc_alter_table_1(name) VALUES('ddd'),('eee'),('fff');
EXPLAIN (VERBOSE true, COSTS false, NODES false) INSERT INTO xc_alter_table_1(name) VALUES('ddd'),('eee'),('fff');
                                           QUERY PLAN                                            
-------------------------------------------------------------------------------------------------
 Insert on public.xc_alter_table_1
   ->  Values Scan on "*VALUES*"
         Output: nextval('xc_alter_table_1_id_seq'::regclass), "*VALUES*".column1, NULL::integer
(3 rows)

SELECT id, name FROM xc_alter_table_1 ORDER BY 1;
 id | name 
----+------
  1 | aaa
  2 | bbb
  3 | ccc
  4 | ddd
  5 | eee
  6 | fff
(6 rows)

-- Check for query generation of remote INSERT SELECT
INSERT INTO xc_alter_table_1(name) SELECT 'ggg';
EXPLAIN (VERBOSE true, COSTS false, NODES false) INSERT INTO xc_alter_table_1(name) SELECT 'ggg';
                                                QUERY PLAN                                                 
-----------------------------------------------------------------------------------------------------------
 Insert on public.xc_alter_table_1
   ->  Result
         Output: nextval('xc_alter_table_1_id_seq'::regclass), 'ggg'::character varying(80), NULL::integer
(3 rows)

SELECT id, name FROM xc_alter_table_1 ORDER BY 1;
 id | name 
----+------
  1 | aaa
  2 | bbb
  3 | ccc
  4 | ddd
  5 | eee
  6 | fff
  7 | ggg
(7 rows)

-- Check for query generation of remote UPDATE
EXPLAIN (VERBOSE true, COSTS false, NODES false) UPDATE xc_alter_table_1 SET name = 'zzz' WHERE id = currval('xc_alter_table_1_id_seq');
                                      QUERY PLAN                                      
--------------------------------------------------------------------------------------
 Update on public.xc_alter_table_1
   ->  Seq Scan on public.xc_alter_table_1
         Output: 'zzz'::character varying(80), shardid, ctid
         Filter: (xc_alter_table_1.id = currval('xc_alter_table_1_id_seq'::regclass))
(4 rows)

UPDATE xc_alter_table_1 SET name = 'zzz' WHERE id = currval('xc_alter_table_1_id_seq');
SELECT id, name FROM xc_alter_table_1 ORDER BY 1;
 id | name 
----+------
  1 | aaa
  2 | bbb
  3 | ccc
  4 | ddd
  5 | eee
  6 | fff
  7 | zzz
(7 rows)

-- Distribution column can be dropped in centralized mode
ALTER TABLE xc_alter_table_1 DROP COLUMN id;
DROP TABLE xc_alter_table_1;
-- Check for multiple columns dropped and created
CREATE TABLE xc_alter_table_2 (a int, b varchar(20), c boolean, d text, e interval) distribute by replication;
INSERT INTO xc_alter_table_2 VALUES (1, 'John', true, 'Master', '01:00:10');
INSERT INTO xc_alter_table_2 VALUES (2, 'Neo', true, 'Slave', '02:34:00');
INSERT INTO xc_alter_table_2 VALUES (3, 'James', false, 'Cascading slave', '00:12:05');
SELECT a, b, c, d, e FROM xc_alter_table_2 ORDER BY a;
 a |   b   | c |        d        |         e         
---+-------+---+-----------------+-------------------
 1 | John  | t | Master          | @ 1 hour 10 secs
 2 | Neo   | t | Slave           | @ 2 hours 34 mins
 3 | James | f | Cascading slave | @ 12 mins 5 secs
(3 rows)

-- Go through standard planner
SET enable_fast_query_shipping TO false;
-- Drop a couple of columns
ALTER TABLE xc_alter_table_2 DROP COLUMN a;
ALTER TABLE xc_alter_table_2 DROP COLUMN d;
ALTER TABLE xc_alter_table_2 DROP COLUMN e;
-- Check for query generation of remote INSERT
EXPLAIN (VERBOSE true, COSTS false, NODES false) INSERT INTO xc_alter_table_2 VALUES ('Kodek', false);
                                             QUERY PLAN                                             
----------------------------------------------------------------------------------------------------
 Insert on public.xc_alter_table_2
   ->  Result
         Output: NULL::integer, 'Kodek'::character varying(20), false, NULL::integer, NULL::integer
(3 rows)

INSERT INTO xc_alter_table_2 VALUES ('Kodek', false);
SELECT b, c FROM xc_alter_table_2 ORDER BY b;
   b   | c 
-------+---
 James | f
 John  | t
 Kodek | f
 Neo   | t
(4 rows)

-- Check for query generation of remote UPDATE
EXPLAIN (VERBOSE true, COSTS false, NODES false) UPDATE xc_alter_table_2 SET b = 'Morphee', c = false WHERE b = 'Neo';
                               QUERY PLAN                               
------------------------------------------------------------------------
 Update on public.xc_alter_table_2
   ->  Seq Scan on public.xc_alter_table_2
         Output: 'Morphee'::character varying(20), false, shardid, ctid
         Filter: ((xc_alter_table_2.b)::text = 'Neo'::text)
(4 rows)

UPDATE xc_alter_table_2 SET b = 'Morphee', c = false WHERE b = 'Neo';
SELECT b, c FROM xc_alter_table_2 ORDER BY b;
    b    | c 
---------+---
 James   | f
 John    | t
 Kodek   | f
 Morphee | f
(4 rows)

-- Add some new columns
ALTER TABLE xc_alter_table_2 ADD COLUMN a int;
ALTER TABLE xc_alter_table_2 ADD COLUMN a2 varchar(20);
-- Check for query generation of remote INSERT
EXPLAIN (VERBOSE true, COSTS false, NODES false) INSERT INTO xc_alter_table_2 (a, a2, b, c) VALUES (100, 'CEO', 'Gordon', true);
                                                              QUERY PLAN                                                               
---------------------------------------------------------------------------------------------------------------------------------------
 Insert on public.xc_alter_table_2
   ->  Result
         Output: NULL::integer, 'Gordon'::character varying(20), true, NULL::integer, NULL::integer, 100, 'CEO'::character varying(20)
(3 rows)

INSERT INTO xc_alter_table_2 (a, a2, b, c) VALUES (100, 'CEO', 'Gordon', true);
SELECT a, a2, b, c FROM xc_alter_table_2 ORDER BY b;
  a  | a2  |    b    | c 
-----+-----+---------+---
 100 | CEO | Gordon  | t
     |     | James   | f
     |     | John    | t
     |     | Kodek   | f
     |     | Morphee | f
(5 rows)

-- Check for query generation of remote UPDATE
EXPLAIN (VERBOSE true, COSTS false, NODES false) UPDATE xc_alter_table_2 SET a = 200, a2 = 'CTO' WHERE b = 'John';
                            QUERY PLAN                            
------------------------------------------------------------------
 Update on public.xc_alter_table_2
   ->  Seq Scan on public.xc_alter_table_2
         Output: 200, 'CTO'::character varying(20), shardid, ctid
         Filter: ((xc_alter_table_2.b)::text = 'John'::text)
(4 rows)

UPDATE xc_alter_table_2 SET a = 200, a2 = 'CTO' WHERE b = 'John';
SELECT a, a2, b, c FROM xc_alter_table_2 ORDER BY b;
  a  | a2  |    b    | c 
-----+-----+---------+---
 100 | CEO | Gordon  | t
     |     | James   | f
 200 | CTO | John    | t
     |     | Kodek   | f
     |     | Morphee | f
(5 rows)

DROP TABLE xc_alter_table_2;
-- Tests for ALTER TABLE redistribution
-- In the following test, a table is redistributed in all the ways possible
-- and effects of redistribution is checked on all the dependent objects
-- Table with integers
CREATE TABLE xc_alter_table_3 (a int, b varchar(10)) DISTRIBUTE BY HASH(a);
INSERT INTO xc_alter_table_3 VALUES (0, NULL);
INSERT INTO xc_alter_table_3 VALUES (1, 'a');
INSERT INTO xc_alter_table_3 VALUES (2, 'aa');
INSERT INTO xc_alter_table_3 VALUES (3, 'aaa');
INSERT INTO xc_alter_table_3 VALUES (4, 'aaaa');
INSERT INTO xc_alter_table_3 VALUES (5, 'aaaaa');
INSERT INTO xc_alter_table_3 VALUES (6, 'aaaaaa');
INSERT INTO xc_alter_table_3 VALUES (7, 'aaaaaaa');
INSERT INTO xc_alter_table_3 VALUES (8, 'aaaaaaaa');
INSERT INTO xc_alter_table_3 VALUES (9, 'aaaaaaaaa');
INSERT INTO xc_alter_table_3 VALUES (10, 'aaaaaaaaaa');
-- Create some objects to check the effect of redistribution
CREATE VIEW xc_alter_table_3_v AS SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3;
CREATE RULE xc_alter_table_3_insert AS ON UPDATE TO xc_alter_table_3 WHERE OLD.a = 11 DO INSERT INTO xc_alter_table_3 VALUES (OLD.a + 1, 'nnn');
PREPARE xc_alter_table_insert AS INSERT INTO xc_alter_table_3 VALUES ($1, $2);
PREPARE xc_alter_table_delete AS DELETE FROM xc_alter_table_3 WHERE a = $1;
PREPARE xc_alter_table_update AS UPDATE xc_alter_table_3 SET b = $2 WHERE a = $1;
-- Now begin the tests
ALTER TABLE xc_alter_table_3 DISTRIBUTE BY HASH(a);
ERROR:  this operation is not permitted
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

EXECUTE xc_alter_table_insert(11, 'b');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b 
---
 b
(1 row)

EXECUTE xc_alter_table_update(11, 'bb');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b  
----
 bb
(1 row)

EXECUTE xc_alter_table_delete(11);
SELECT b FROM xc_alter_table_3 WHERE a = 11 or a = 12;
  b  
-----
 nnn
(1 row)

EXECUTE xc_alter_table_delete(12);
ALTER TABLE xc_alter_table_3 DISTRIBUTE BY HASH(b);
ERROR:  this operation is not permitted
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

EXECUTE xc_alter_table_insert(11, 'b');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b 
---
 b
(1 row)

EXECUTE xc_alter_table_update(11, 'bb');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b  
----
 bb
(1 row)

EXECUTE xc_alter_table_delete(11);
SELECT b FROM xc_alter_table_3 WHERE a = 11 or a = 12;
  b  
-----
 nnn
(1 row)

EXECUTE xc_alter_table_delete(12);
ALTER TABLE xc_alter_table_3 DISTRIBUTE BY ROUNDROBIN;
ERROR:  this operation is not permitted
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

EXECUTE xc_alter_table_insert(11, 'b');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b 
---
 b
(1 row)

EXECUTE xc_alter_table_update(11, 'bb');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b  
----
 bb
(1 row)

EXECUTE xc_alter_table_delete(11);
SELECT b FROM xc_alter_table_3 WHERE a = 11 or a = 12;
  b  
-----
 nnn
(1 row)

EXECUTE xc_alter_table_delete(12);
ALTER TABLE xc_alter_table_3 DISTRIBUTE BY MODULO(a);
ERROR:  this operation is not permitted
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

EXECUTE xc_alter_table_insert(11, 'b');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b 
---
 b
(1 row)

EXECUTE xc_alter_table_update(11, 'bb');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b  
----
 bb
(1 row)

EXECUTE xc_alter_table_delete(11);
SELECT b FROM xc_alter_table_3 WHERE a = 11 or a = 12;
  b  
-----
 nnn
(1 row)

EXECUTE xc_alter_table_delete(12);
ALTER TABLE xc_alter_table_3 DISTRIBUTE BY MODULO(b);
ERROR:  this operation is not permitted
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

EXECUTE xc_alter_table_insert(11, 'b');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b 
---
 b
(1 row)

EXECUTE xc_alter_table_update(11, 'bb');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b  
----
 bb
(1 row)

EXECUTE xc_alter_table_delete(11);
SELECT b FROM xc_alter_table_3 WHERE a = 11 or a = 12;
  b  
-----
 nnn
(1 row)

EXECUTE xc_alter_table_delete(12);
-- Index and redistribution
CREATE INDEX xc_alter_table_3_index ON xc_alter_table_3(a);
ALTER TABLE xc_alter_table_3 DISTRIBUTE BY HASH(a);
ERROR:  this operation is not permitted
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

EXECUTE xc_alter_table_insert(11, 'b');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b 
---
 b
(1 row)

EXECUTE xc_alter_table_update(11, 'bb');
SELECT b FROM xc_alter_table_3 WHERE a = 11;
 b  
----
 bb
(1 row)

EXECUTE xc_alter_table_delete(11);
SELECT b FROM xc_alter_table_3 WHERE a = 11 or a = 12;
  b  
-----
 nnn
(1 row)

EXECUTE xc_alter_table_delete(12);
-- Add column on table
ALTER TABLE xc_alter_table_3 ADD COLUMN c int DEFAULT 4;
ALTER TABLE xc_alter_table_3 DISTRIBUTE BY REPLICATION;
ERROR:  this operation is not permitted
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

-- Drop column on table
ALTER TABLE xc_alter_table_3 DROP COLUMN b CASCADE;
NOTICE:  drop cascades to rule xc_alter_table_3_insert on table xc_alter_table_3
ALTER TABLE xc_alter_table_3 DISTRIBUTE BY HASH(a);
ERROR:  this operation is not permitted
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

-- Remanipulate table once again and distribute on old column
ALTER TABLE xc_alter_table_3 DROP COLUMN c;
ALTER TABLE xc_alter_table_3 ADD COLUMN b varchar(3) default 'aaa';
ALTER TABLE xc_alter_table_3 DISTRIBUTE BY HASH(a);
ERROR:  this operation is not permitted
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

-- Change the node list
SELECT alter_table_change_nodes('xc_alter_table_3', '{1}', 'to', NULL);
ERROR:  this operation is not permitted
CONTEXT:  SQL statement "ALTER TABLE xc_alter_table_3 TO NODE (datanode_1)"
PL/pgSQL function alter_table_change_nodes(character varying,integer[],character varying,character varying) line 79 at EXECUTE
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

-- Add some nodes on it
SELECT alter_table_change_nodes('xc_alter_table_3', '{2,4,5}', 'add', NULL);
ERROR:  syntax error at or near ")"
LINE 1: ALTER TABLE xc_alter_table_3 TO NODE ()
                                              ^
QUERY:  ALTER TABLE xc_alter_table_3 TO NODE ()
CONTEXT:  PL/pgSQL function alter_table_change_nodes(character varying,integer[],character varying,character varying) line 79 at EXECUTE
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check in tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

-- Remove some nodes on it
SELECT alter_table_change_nodes('xc_alter_table_3', '{3}', 'add', NULL);
ERROR:  syntax error at or near ")"
LINE 1: ALTER TABLE xc_alter_table_3 TO NODE ()
                                              ^
QUERY:  ALTER TABLE xc_alter_table_3 TO NODE ()
CONTEXT:  PL/pgSQL function alter_table_change_nodes(character varying,integer[],character varying,character varying) line 79 at EXECUTE
SELECT alter_table_change_nodes('xc_alter_table_3', '{2,3,5}', 'delete', NULL);
ERROR:  syntax error at or near ")"
LINE 1: ALTER TABLE xc_alter_table_3 TO NODE ()
                                              ^
QUERY:  ALTER TABLE xc_alter_table_3 TO NODE ()
CONTEXT:  PL/pgSQL function alter_table_change_nodes(character varying,integer[],character varying,character varying) line 79 at EXECUTE
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

-- Multiple operations with replication
SELECT alter_table_change_nodes('xc_alter_table_3', '{1,3,4,5}', 'to', 'replication');
ERROR:  this operation is not permitted
CONTEXT:  SQL statement "ALTER TABLE xc_alter_table_3 TO NODE (datanode_1), DISTRIBUTE BY replication"
PL/pgSQL function alter_table_change_nodes(character varying,integer[],character varying,character varying) line 79 at EXECUTE
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

-- Manipulate number of nodes to include and remove nodes on a replicated table
-- On removed nodes data is deleted and on new nodes data is added
SELECT alter_table_change_nodes('xc_alter_table_3', '{2,3,5}', 'to', NULL);
ERROR:  syntax error at or near ")"
LINE 1: ALTER TABLE xc_alter_table_3 TO NODE ()
                                              ^
QUERY:  ALTER TABLE xc_alter_table_3 TO NODE ()
CONTEXT:  PL/pgSQL function alter_table_change_nodes(character varying,integer[],character varying,character varying) line 79 at EXECUTE
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

-- Re-do a double operation with hash this time
SELECT alter_table_change_nodes('xc_alter_table_3', '{2}', 'delete', 'hash(a)');
ERROR:  syntax error at or near ")"
LINE 1: ALTER TABLE xc_alter_table_3 TO NODE (), DISTRIBUTE BY hash(...
                                              ^
QUERY:  ALTER TABLE xc_alter_table_3 TO NODE (), DISTRIBUTE BY hash(a)
CONTEXT:  PL/pgSQL function alter_table_change_nodes(character varying,integer[],character varying,character varying) line 79 at EXECUTE
SELECT count(*), sum(a), avg(a) FROM xc_alter_table_3; -- Check on tuple presence
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

SELECT * FROM xc_alter_table_3_v;
 count | sum |        avg         
-------+-----+--------------------
    11 |  55 | 5.0000000000000000
(1 row)

-- Error checks
ALTER TABLE xc_alter_table_3 ADD COLUMN b int, DISTRIBUTE BY HASH(a);
ERROR:  this operation is not permitted
-- Clean up
DROP TABLE xc_alter_table_3 CASCADE;
NOTICE:  drop cascades to view xc_alter_table_3_v
-- bugs for alter table .... reference
create schema dwrpt;
set search_path to 'dwrpt';
CREATE TABLE dwrpt.act_ru_execution (
    id_ varchar(64),
    rev_ numeric,
    proc_inst_id_ varchar(64),
    business_key_ varchar(255),
    parent_id_ varchar(64),
    proc_def_id_ varchar(64),
    super_exec_ varchar(64),
    act_id_ varchar(255),
    is_active_ numeric(1, 0),
    is_concurrent_ numeric(1, 0),
    is_scope_ numeric(1, 0),
    suspension_state_ numeric,
    PRIMARY KEY (id_)
) DISTRIBUTE BY SHARD(ID_);
alter table act_ru_execution add constraint act_fk_exe_procinst foreign key (proc_inst_id_) references dwrpt.act_ru_execution (id_) on delete NO ACTION;
drop schema dwrpt cascade;
NOTICE:  drop cascades to table act_ru_execution
\c
drop schema dwrpt cascade;
ERROR:  schema "dwrpt" does not exist
CREATE TABLE act_ru_execution (
    id_ varchar(64),
    rev_ numeric,
    proc_inst_id_ varchar(64),
    business_key_ varchar(255),
    parent_id_ varchar(64),
    proc_def_id_ varchar(64),
    super_exec_ varchar(64),
    act_id_ varchar(255),
    is_active_ numeric(1, 0),
    is_concurrent_ numeric(1, 0),
    is_scope_ numeric(1, 0),
    suspension_state_ numeric,
    PRIMARY KEY (id_)
) DISTRIBUTE BY SHARD(ID_);
alter table act_ru_execution add constraint act_fk_exe_procinst foreign key (proc_inst_id_) references act_ru_execution (id_) on delete NO ACTION;
drop table act_ru_execution;
