\set ECHO all
\c regression_ora
----prepare----
create extension opentenbase_mls;
select current_database();
 current_database 
------------------
 regression_ora
(1 row)

create user godlike superuser;
create user rubberneck superuser;
create user godlike2 superuser;
\c regression godlike
create extension opentenbase_mls;
select current_database();
 current_database 
------------------
 regression
(1 row)

select current_user;
 current_user 
--------------
 godlike
(1 row)

-----------------DATAMASK TEST BEGIN--------------------
create table tbl_datamask_xx( i int, i_m int, ii int2, ii_m int2, j bigint, j_m bigint, x varchar, x_m varchar, y text, y_m text) distribute by shard(i);
insert into tbl_datamask_xx values(1024, 1024, 7788, 7788, 42949672960,42949672960, '112233201804035566', '112233201804035566', 'abcdefghijk', 'abcdefghijk');
insert into tbl_datamask_xx(i, x) values(1025, 'all is null');
insert into tbl_datamask_xx(i, x, x_m, y_m) values(1026, 'all is null', 'this is a very very very looooooooong string, i guess here is over 32 bytes length, emmmmm', 'opentenbase!!~~~');
create table tbl_datamask_yy( i int, i_m int, ii int2, ii_m int2, j bigint, j_m bigint, x varchar, x_m varchar, y text, y_m text) distribute by shard(i);;
insert into tbl_datamask_yy values(1024, 1024, 7788, 7788, 42949672960,42949672960, '112233201804035566', '112233201804035566', 'abcdefghijk', 'abcdefghijk');
create table tbl_datamask_zz ( i int , j text , z text ) distribute by shard(i);;
insert into tbl_datamask_zz values(1024,'x','y');
--let mls_admin create datamask policy
\c regression mls_admin
select current_database();
 current_database 
------------------
 regression
(1 row)

select current_user;
 current_user 
--------------
 mls_admin
(1 row)

--case1: api robustness test
--fail:optionval 
select MLS_DATAMASK_CREATE('public', 'tbl_datamask_xx', 'ii_m', 0);
ERROR:  INVALID INPUT:optionval:0
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 36 at RAISE
--fail:schema_name 
select MLS_DATAMASK_CREATE('', 'tbl_datamask_xx', 'ii_m', 1);
ERROR:  INVALID INPUT:schema_name is null
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 32 at RAISE
select MLS_DATAMASK_CREATE('tbl_datamask_xx', 'ii_m', 1);
ERROR:  function mls_datamask_create(unknown, unknown, integer) does not exist
LINE 1: select MLS_DATAMASK_CREATE('tbl_datamask_xx', 'ii_m', 1);
               ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
--fail:table_name 
select MLS_DATAMASK_CREATE('public', 'tbl_datamask_xxx', 'ii_m', 1);
ERROR:  INVALID INPUT:table_name:tbl_datamask_xxx or schema_name:public or attr_name:ii_m not exists
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 43 at RAISE
--fail:attname 
select MLS_DATAMASK_CREATE('public', 'tbl_datamask_xx', 'xxx', 1);
ERROR:  INVALID INPUT:table_name:tbl_datamask_xx or schema_name:public or attr_name:xxx not exists
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 43 at RAISE
--fail:over length
select MLS_DATAMASK_CREATE('public', 'tbl_datamask_xx', 'x_m',  2, 33);
ERROR:  INVALID INPUT:mask length is 33 is out of range
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 68 at RAISE
--fail:system table is unsupported
select MLS_DATAMASK_CREATE('pg_catalog', 'pg_database', 'datdba',  1, 1024);
ERROR:  system table:pg_database is unsupported
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 48 at RAISE
select MLS_DATAMASK_CREATE('pg_catalog', 'pg_database', 'datcollate',  2, 3);
ERROR:  system table:pg_database is unsupported
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 48 at RAISE
select MLS_DATAMASK_CREATE('pg_catalog', 'pg_database', 'datcollate',  4, 3);
ERROR:  system table:pg_database is unsupported
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 48 at RAISE
select MLS_DATAMASK_CREATE('pg_catalog', 'pg_database', 'datconnlimit',  3, 3);
ERROR:  system table:pg_database is unsupported
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 48 at RAISE
--ok:indentify default value
select MLS_DATAMASK_CREATE('public', 'tbl_datamask_xx', 'i_m',  1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_datamask_xx', 'ii_m', 1, 88888888);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_datamask_xx', 'j_m',  1, 9999999);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_datamask_xx', 'x_m',  2, 32);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_datamask_xx', 'y_m',  4);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_datamask_xx', 'i_m',  'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_datamask_xx', 'ii_m', 'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_datamask_xx', 'j_m',  'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_datamask_xx', 'x_m',  'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_datamask_xx', 'y_m',  'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_datamask_xx', 'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

--case2:compare result among crowds
\c regression rubberneck
select * from tbl_datamask_xx order by i;
  i   | i_m  |  ii  | ii_m  |      j      |   j_m   |         x          |                                            x_m                                             |      y      |     y_m     
------+------+------+-------+-------------+---------+--------------------+--------------------------------------------------------------------------------------------+-------------+-------------
 1024 | 9999 | 7788 | 22072 | 42949672960 | 9999999 | 112233201804035566 | XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX                                                           | abcdefghijk | abcdefgXXXX
 1025 | 9999 |      | 22072 |             | 9999999 | all is null        | XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX                                                           |             | XXXX
 1026 | 9999 |      | 22072 |             | 9999999 | all is null        | XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXooong string, i guess here is over 32 bytes length, emmmmm |             | opentenbase!XXXX
(3 rows)

\c regression godlike
select * from tbl_datamask_xx order by i;
  i   | i_m  |  ii  | ii_m |      j      |     j_m     |         x          |                                            x_m                                             |      y      |     y_m     
------+------+------+------+-------------+-------------+--------------------+--------------------------------------------------------------------------------------------+-------------+-------------
 1024 | 1024 | 7788 | 7788 | 42949672960 | 42949672960 | 112233201804035566 | 112233201804035566                                                                         | abcdefghijk | abcdefghijk
 1025 |      |      |      |             |             | all is null        |                                                                                            |             | 
 1026 |      |      |      |             |             | all is null        | this is a very very very looooooooong string, i guess here is over 32 bytes length, emmmmm |             | opentenbase!!~~~
(3 rows)

\c regression godlike2
select * from tbl_datamask_xx order by i;
  i   | i_m  |  ii  | ii_m |      j      |     j_m     |         x          |                                            x_m                                             |      y      |     y_m     
------+------+------+------+-------------+-------------+--------------------+--------------------------------------------------------------------------------------------+-------------+-------------
 1024 | 1024 | 7788 | 7788 | 42949672960 | 42949672960 | 112233201804035566 | 112233201804035566                                                                         | abcdefghijk | abcdefghijk
 1025 |      |      |      |             |             | all is null        |                                                                                            |             | 
 1026 |      |      |      |             |             | all is null        | this is a very very very looooooooong string, i guess here is over 32 bytes length, emmmmm |             | opentenbase!!~~~
(3 rows)

--case3:update datamask datum value
\c regression mls_admin
select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'tbl_datamask_xx', 'i_m', 7777);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'tbl_datamask_xx', 'x_m', 5);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

\c regression rubberneck
select * from tbl_datamask_xx order by i;
  i   | i_m  |  ii  | ii_m  |      j      |   j_m   |         x          |                                            x_m                                             |      y      |     y_m     
------+------+------+-------+-------------+---------+--------------------+--------------------------------------------------------------------------------------------+-------------+-------------
 1024 | 7777 | 7788 | 22072 | 42949672960 | 9999999 | 112233201804035566 | XXXXX3201804035566                                                                         | abcdefghijk | abcdefgXXXX
 1025 | 7777 |      | 22072 |             | 9999999 | all is null        | XXXXX                                                                                      |             | XXXX
 1026 | 7777 |      | 22072 |             | 9999999 | all is null        | XXXXXis a very very very looooooooong string, i guess here is over 32 bytes length, emmmmm |             | opentenbase!XXXX
(3 rows)

--case4:enable or disable datamask policy on one column
\c regression mls_admin
select MLS_DATAMASK_DISABLE_USER_POLICY('public', 'tbl_datamask_xx', 'i_m', 'godlike');
 mls_datamask_disable_user_policy 
----------------------------------
 t
(1 row)

\c regression godlike
select * from tbl_datamask_xx order by i;
  i   | i_m  |  ii  | ii_m |      j      |     j_m     |         x          |                                            x_m                                             |      y      |     y_m     
------+------+------+------+-------------+-------------+--------------------+--------------------------------------------------------------------------------------------+-------------+-------------
 1024 | 7777 | 7788 | 7788 | 42949672960 | 42949672960 | 112233201804035566 | 112233201804035566                                                                         | abcdefghijk | abcdefghijk
 1025 | 7777 |      |      |             |             | all is null        |                                                                                            |             | 
 1026 | 7777 |      |      |             |             | all is null        | this is a very very very looooooooong string, i guess here is over 32 bytes length, emmmmm |             | opentenbase!!~~~
(3 rows)

\c regression mls_admin
select MLS_DATAMASK_ENABLE_USER_POLICY('public', 'tbl_datamask_xx', 'i_m', 'godlike');
 mls_datamask_enable_user_policy 
---------------------------------
 t
(1 row)

\c regression godlike
select * from tbl_datamask_xx order by i;
  i   | i_m  |  ii  | ii_m |      j      |     j_m     |         x          |                                            x_m                                             |      y      |     y_m     
------+------+------+------+-------------+-------------+--------------------+--------------------------------------------------------------------------------------------+-------------+-------------
 1024 | 1024 | 7788 | 7788 | 42949672960 | 42949672960 | 112233201804035566 | 112233201804035566                                                                         | abcdefghijk | abcdefghijk
 1025 |      |      |      |             |             | all is null        |                                                                                            |             | 
 1026 |      |      |      |             |             | all is null        | this is a very very very looooooooong string, i guess here is over 32 bytes length, emmmmm |             | opentenbase!!~~~
(3 rows)

----the follows should fail, cause datamask column exist in expr
--case5:fail, check insert returning value
\c regression rubberneck
insert into tbl_datamask_xx (i, i_m)values(10240, 10240) returning i_m;
  i_m  
-------
 10240
(1 row)

--case6:fail, join test, there should be no record returning, cause, i_m in xx has mask
select tbl_datamask_xx.i from tbl_datamask_xx, tbl_datamask_yy where tbl_datamask_xx.i_m = tbl_datamask_yy.i_m;
ERROR:  column(attrname:i_m) with datamask policy is forbidden in expression
--case7:fail, select test, 
select * from tbl_datamask_xx where i_m = 1024 order by i;
ERROR:  column(attrname:i_m) with datamask policy is forbidden in expression
select * from tbl_datamask_xx where i_m = 7777 order by i;
ERROR:  column(attrname:i_m) with datamask policy is forbidden in expression
--case8:fail, join test, 
select * from tbl_datamask_xx xx, (select yy.i from tbl_datamask_yy yy, tbl_datamask_zz zz where yy.i=zz.i) a where xx.i = a.i order by xx.i;
  i   | i_m  |  ii  | ii_m  |      j      |   j_m   |         x          |        x_m         |      y      |     y_m     |  i   
------+------+------+-------+-------------+---------+--------------------+--------------------+-------------+-------------+------
 1024 | 7777 | 7788 | 22072 | 42949672960 | 9999999 | 112233201804035566 | XXXXX3201804035566 | abcdefghijk | abcdefgXXXX | 1024
(1 row)

select * from tbl_datamask_yy yy join tbl_datamask_xx xx on yy.i_m = xx.i_m order by xx.i;
ERROR:  column(attrname:i_m) with datamask policy is forbidden in expression
select * from tbl_datamask_yy yy join tbl_datamask_xx xx using (i_m) order by xx.i;
ERROR:  column(attrname:i_m) with datamask policy is forbidden in expression
select * from tbl_datamask_yy yy, (select z.i from tbl_datamask_zz z , ( select i, i_m from tbl_datamask_xx )x where x.i_m = 1024 and z.i = x.i) xx where yy.i = xx.i order by xx.i;
ERROR:  column(attrname:i_m) with datamask policy is forbidden in expression
--case9:drop datamask policy
\c regression mls_admin
select MLS_DATAMASK_DROP_USER_POLICY('public', 'tbl_datamask_xx', 'i_m', 'godlike');
 mls_datamask_drop_user_policy 
-------------------------------
 t
(1 row)

select MLS_DATAMASK_DROP_USER_POLICY('public', 'tbl_datamask_xx', 'x_m', 'godlike');
 mls_datamask_drop_user_policy 
-------------------------------
 t
(1 row)

\c regression godlike
select * from tbl_datamask_xx order by i;
   i   | i_m  |  ii  | ii_m |      j      |     j_m     |         x          |                                            x_m                                             |      y      |     y_m     
-------+------+------+------+-------------+-------------+--------------------+--------------------------------------------------------------------------------------------+-------------+-------------
  1024 | 7777 | 7788 | 7788 | 42949672960 | 42949672960 | 112233201804035566 | XXXXX3201804035566                                                                         | abcdefghijk | abcdefghijk
  1025 | 7777 |      |      |             |             | all is null        | XXXXX                                                                                      |             | 
  1026 | 7777 |      |      |             |             | all is null        | XXXXXis a very very very looooooooong string, i guess here is over 32 bytes length, emmmmm |             | opentenbase!!~~~
 10240 | 7777 |      |      |             |             |                    | XXXXX                                                                                      |             | 
(4 rows)

--case12:
\c regression godlike
create table tbl_xx(id int, tt timestamp, ff4 float4, ff8 float8, nn numeric, cc char, cc_2 char(1), cc_3 char(6), cc_4 char(10), varch2 varchar);
insert into tbl_xx values(1024, '2018-09-10 1:2:3', 99.8, 777.777, 399.01, 'x', 'y', 'uiopw','abcefghijk', 'a long story');
select * from tbl_xx order by id;
  id  |            tt            | ff4  |   ff8   |   nn   | cc | cc_2 |  cc_3  |    cc_4    |    varch2    
------+--------------------------+------+---------+--------+----+------+--------+------------+--------------
 1024 | Mon Sep 10 01:02:03 2018 | 99.8 | 777.777 | 399.01 | x  | y    | uiopw  | abcefghijk | a long story
(1 row)

\c regression mls_admin
--fail, timestamp type needs explicit mask value input
select MLS_DATAMASK_CREATE('public', 'tbl_xx', 'tt',     3);
ERROR:  INVALID INPUT:timestamp type needs explict input mask value, table:public.tbl_xx, attribute name:tt
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 58 at RAISE
select MLS_DATAMASK_CREATE('public', 'tbl_xx', 'tt',     3, '2099-10-10 10:10:10');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_xx', 'ff4',    3, 12345.6);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_xx', 'ff8',    3, 12345.678);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_xx', 'nn',     3, 500.001);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_xx', 'cc',     2, 12);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_xx', 'cc_2',   4, 12);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_xx', 'cc_3',   3, 'opentenbase security');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_xx', 'varch2', 4, 10);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_xx', 'tt',     'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_xx', 'ff4',    'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_xx', 'ff8',    'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_xx', 'nn',     'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_xx', 'cc',     'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_xx', 'cc_2',   'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_xx', 'cc_3',   'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_xx', 'varch2', 'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

\c regression rubberneck
select * from tbl_xx;
  id  |            tt            |   ff4   |    ff8    |   nn    |      cc      |     cc_2     |      cc_3      |    cc_4    |    varch2    
------+--------------------------+---------+-----------+---------+--------------+--------------+----------------+------------+--------------
 1024 | Sat Oct 10 10:10:10 2099 | 12345.6 | 12345.678 | 500.001 | XXXXXXXXXXXX | XXXXXXXXXXXX | opentenbase security | abcefghijk | a XXXXXXXXXX
(1 row)

\c regression godlike
select * from tbl_xx order by id;
  id  |            tt            | ff4  |   ff8   |   nn   | cc | cc_2 |  cc_3  |    cc_4    |    varch2    
------+--------------------------+------+---------+--------+----+------+--------+------------+--------------
 1024 | Mon Sep 10 01:02:03 2018 | 99.8 | 777.777 | 399.01 | x  | y    | uiopw  | abcefghijk | a long story
(1 row)

--case13:
\c regression rubberneck
create table tbl_yy(id int, tt timestamp, ff4 float4, ff8 float8, nn numeric, cc char, cc_2 char(1), cc_3 char(6), cc_4 char(10), varch2 varchar);
insert into tbl_yy select * from tbl_xx order by id asc;
select * from tbl_yy;
  id  |            tt            |   ff4   |    ff8    |   nn    |      cc      |     cc_2     |      cc_3      |    cc_4    |    varch2    
------+--------------------------+---------+-----------+---------+--------------+--------------+----------------+------------+--------------
 1024 | Sat Oct 10 10:10:10 2099 | 12345.6 | 12345.678 | 500.001 | XXXXXXXXXXXX | XXXXXXXXXXXX | opentenbase security | abcefghijk | a XXXXXXXXXX
(1 row)

drop table tbl_yy;
--case, shard and partition table
\c regression godlike
create table tbl_datamask_shard_part(f1 int, f2 timestamp default now(), f3 int) 
partition by range (f2) 
    begin (timestamp without time zone '2018-01-01 0:0:0') step (interval '1 month') 
    partitions (6) 
    distribute by shard(f1) 
to group default_group ; 
insert into tbl_datamask_shard_part values( 1024, '2018-01-01 1:1:1', 1024);
insert into tbl_datamask_shard_part values( 2048, '2018-01-02 2:2:2', 2048);
insert into tbl_datamask_shard_part values( 3096, '2018-01-03 3:3:3', 3096);
insert into tbl_datamask_shard_part values( 4192, '2018-01-04 4:4:4', 4192);
insert into tbl_datamask_shard_part values( 7788, '2018-02-04 4:4:4', 4192);
insert into tbl_datamask_shard_part values( 7789, '2018-02-04 4:4:4', 4192);
select * from tbl_datamask_shard_part order by f1;
  f1  |            f2            |  f3  
------+--------------------------+------
 1024 | Mon Jan 01 01:01:01 2018 | 1024
 2048 | Tue Jan 02 02:02:02 2018 | 2048
 3096 | Wed Jan 03 03:03:03 2018 | 3096
 4192 | Thu Jan 04 04:04:04 2018 | 4192
 7788 | Sun Feb 04 04:04:04 2018 | 4192
 7789 | Sun Feb 04 04:04:04 2018 | 4192
(6 rows)

\c regression mls_admin
select MLS_DATAMASK_CREATE('public', 'tbl_datamask_shard_part', 'f1',  1, 9999);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_datamask_shard_part', 'f2',  3, '2099-09-09 9:9:9');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'tbl_datamask_shard_part', 'f3',  1, 10007);
 mls_datamask_create 
---------------------
 t
(1 row)

\c regression godlike
select * from tbl_datamask_shard_part order by f1;
  f1  |            f2            |  f3   
------+--------------------------+-------
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
(6 rows)

\c - godlike
create schema mls_schema;
create table mls_schema.test2(f1 int, f2 timestamp default now(), f3 int) 
to group default_group ;
create table mls_schema.test3_not_mls_policy(f1 int, f2 timestamp default now(), f3 int) 
to group default_group ;
insert into mls_schema.test2 values( 1024, '2018-01-01 1:1:1', 1024);
insert into mls_schema.test2 values( 2048, '2018-01-02 2:2:2', 2048);
insert into mls_schema.test2 values( 3096, '2018-01-03 3:3:3', 3096);
insert into mls_schema.test2 values( 4192, '2018-01-04 4:4:4', 4192);
select * from mls_schema.test2 order by f1;
  f1  |            f2            |  f3  
------+--------------------------+------
 1024 | Mon Jan 01 01:01:01 2018 | 1024
 2048 | Tue Jan 02 02:02:02 2018 | 2048
 3096 | Wed Jan 03 03:03:03 2018 | 3096
 4192 | Thu Jan 04 04:04:04 2018 | 4192
(4 rows)

insert into mls_schema.test3_not_mls_policy values( 1024, '2018-01-01 1:1:1', 1024);
insert into mls_schema.test3_not_mls_policy values( 2048, '2018-01-02 2:2:2', 2048);
insert into mls_schema.test3_not_mls_policy values( 3096, '2018-01-03 3:3:3', 3096);
insert into mls_schema.test3_not_mls_policy values( 4192, '2018-01-04 4:4:4', 4192);
select * from mls_schema.test3_not_mls_policy order by f1;
  f1  |            f2            |  f3  
------+--------------------------+------
 1024 | Mon Jan 01 01:01:01 2018 | 1024
 2048 | Tue Jan 02 02:02:02 2018 | 2048
 3096 | Wed Jan 03 03:03:03 2018 | 3096
 4192 | Thu Jan 04 04:04:04 2018 | 4192
(4 rows)

grant usage on schema mls_schema to mls_admin;   
\c regression mls_admin
select MLS_DATAMASK_CREATE('mls_schema', 'test2', 'f1',  1, 9999);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('mls_schema', 'test2', 'f2',  3, '2099-09-09 9:9:9');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('mls_schema', 'test2', 'f3',  1, 10007);
 mls_datamask_create 
---------------------
 t
(1 row)

\c regression godlike
select * from mls_schema.test2 order by f1;
  f1  |            f2            |  f3   
------+--------------------------+-------
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
(4 rows)

create user user_in_white_list superuser;
\c - user_in_white_list
select * from mls_schema.test2 order by f1;
  f1  |            f2            |  f3   
------+--------------------------+-------
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
(4 rows)

\c - mls_admin
select MLS_DATAMASK_CREATE_USER_POLICY('mls_schema', 'test2', 'f1',     'user_in_white_list');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('mls_schema', 'test2', 'f2',    'user_in_white_list');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('mls_schema', 'test2', 'f3',    'user_in_white_list');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

\c - user_in_white_list
select * from mls_schema.test2 order by f1;
  f1  |            f2            |  f3  
------+--------------------------+------
 1024 | Mon Jan 01 01:01:01 2018 | 1024
 2048 | Tue Jan 02 02:02:02 2018 | 2048
 3096 | Wed Jan 03 03:03:03 2018 | 3096
 4192 | Thu Jan 04 04:04:04 2018 | 4192
(4 rows)

\c regression godlike
create table tbl_datamask_unsupport(i int, bb point);
\c regression mls_admin
select MLS_DATAMASK_CREATE('public', 'tbl_datamask_unsupport', 'bb', 1);
ERROR:  INVALID INPUT:unsupported datatype, table:public.tbl_datamask_unsupport, attribute name:bb
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,numeric) line 54 at RAISE
--case, should fail, drop the user who is in datamask white list
\c - godlike
drop user user_in_white_list;
ERROR:  could not drop role:user_in_white_list, cause this role has mls poilcy bound
drop table tbl_datamask_unsupport;
--case, should fail, rename user who is in datamask white list
alter user user_in_white_list rename to user_in_white_list_2;
ERROR:  could not rename role:user_in_white_list, cause this role has mls poilcy bound
--case, should fail, alter column has mls policy
alter table mls_schema.test2 rename f2 to f2222;
ERROR:  could not rename column:f2, cause column has mls poilcy bound
--case, should fail, drop column has mls policy
alter table mls_schema.test2 drop column f2;
ERROR:  could not drop column:f2, cause column has mls poilcy bound
--case, should fail, drop table has mls policy
drop table mls_schema.test2, mls_schema.test3_not_mls_policy;
ERROR:  could not drop table:test2, cause mls poilcy is bound
--while, mls_schema.test3_not_mls_policy has not been dropped.
select * from mls_schema.test2 order by f1;
  f1  |            f2            |  f3   
------+--------------------------+-------
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
 9999 | Wed Sep 09 09:09:09 2099 | 10007
(4 rows)

select * from mls_schema.test3_not_mls_policy order by f1;
  f1  |            f2            |  f3  
------+--------------------------+------
 1024 | Mon Jan 01 01:01:01 2018 | 1024
 2048 | Tue Jan 02 02:02:02 2018 | 2048
 3096 | Wed Jan 03 03:03:03 2018 | 3096
 4192 | Thu Jan 04 04:04:04 2018 | 4192
(4 rows)

--case, should fail, rename table has mls policy
alter table mls_schema.test2 rename to test2222;
ERROR:  could not rename table:test2, cause mls poilcy is bound
--case, should fail, drop schema has mls policy on table
--drop schema mls_schema;
--case, should fail, rename schema has mls policy on table
alter schema mls_schema rename to mls_schema2222;
ERROR:  could not rename schema:mls_schema, cause there are tables having mls poilcy bound in this schema
--case, success, datamask could be dropped even table is not empty.
\c - mls_admin
select MLS_DATAMASK_DROP_TABLE_POLICY('mls_schema', 'test2', 'f1');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

--fail, not empty
\c - godlike 
drop table mls_schema.test2;
ERROR:  could not drop table:test2, cause mls poilcy is bound
truncate table mls_schema.test2;
--success
\c - mls_admin
select MLS_DATAMASK_DROP_TABLE_POLICY('mls_schema', 'test2', 'f1');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

select MLS_DATAMASK_DROP_TABLE_POLICY('mls_schema', 'test2');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

--success, empty and no policy
\c - godlike
drop table mls_schema.test2;
drop table mls_schema.test3_not_mls_policy;
--fail, cause table is dropped
\c - mls_admin
SELECT MLS_DATAMASK_DROP_USER_POLICY('mls_schema', 'test2', 'f1', 'user_in_white_list');
ERROR:  INVALID INPUT:table_name:test2 or schema_name:mls_schema or attr_name:f1 not exists, use MLS_DATAMASK_CLEAN instead
CONTEXT:  PL/pgSQL function mls_datamask_drop_user_policy(name,name,name,name,boolean) line 28 at RAISE
SELECT MLS_DATAMASK_DROP_USER_POLICY('mls_schema', 'test2', 'f1', 'user_in_white_list');
ERROR:  INVALID INPUT:table_name:test2 or schema_name:mls_schema or attr_name:f1 not exists, use MLS_DATAMASK_CLEAN instead
CONTEXT:  PL/pgSQL function mls_datamask_drop_user_policy(name,name,name,name,boolean) line 28 at RAISE
SELECT MLS_DATAMASK_DROP_USER_POLICY('mls_schema', 'test2', 'f1', 'user_in_white_list');
ERROR:  INVALID INPUT:table_name:test2 or schema_name:mls_schema or attr_name:f1 not exists, use MLS_DATAMASK_CLEAN instead
CONTEXT:  PL/pgSQL function mls_datamask_drop_user_policy(name,name,name,name,boolean) line 28 at RAISE
--success, not policy
--\c - godlike 
--drop user user_in_white_list;
---select with index
\c - godlike
drop table if exists data_mask_primary_key;
NOTICE:  table "data_mask_primary_key" does not exist, skipping
create table data_mask_primary_key(id int2 primary key, f1 int2, f2 int4, f3 int8);
insert into data_mask_primary_key(id,f1,f2,f3) values(1, 111, 222, 333);
insert into data_mask_primary_key(id,f1,f2,f3) values(2, 11, 22, 33);
insert into data_mask_primary_key(id,f1,f2,f3) values(3, 1, 2, 3);
\c - mls_admin
select MLS_DATAMASK_CREATE('public', 'data_mask_primary_key', 'id', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'data_mask_primary_key', 'f1', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'data_mask_primary_key', 'f2', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'data_mask_primary_key', 'f3', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

\c - godlike
select * from data_mask_primary_key order by id asc;
  id  |  f1  |  f2  |  f3  
------+------+------+------
 9999 | 9999 | 9999 | 9999
 9999 | 9999 | 9999 | 9999
 9999 | 9999 | 9999 | 9999
(3 rows)

truncate data_mask_primary_key;
\c - mls_admin
select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'data_mask_primary_key');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

--case14: varchar\text has default mask value
\c - godlike
drop table if exists test_table_e;
NOTICE:  table "test_table_e" does not exist, skipping
create table test_table_e(e_a int2, e_b int4, e_c int8, e_d varchar, e_e text, e_f char(20), e_g varchar, e_h numeric, e_i timestamp, e_j float4, e_k float8) distribute by shard(e_a);
\c - mls_admin
select MLS_DATAMASK_CREATE('public', 'test_table_e', 'e_b', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_e', 'e_c', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_e', 'e_d', 3, 'ddd');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_e', 'e_e', 3, 'eee');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_e', 'e_f', 3, 'fff');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_e', 'e_g', 3, 'ggg');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_e', 'e_h', 3, 'hhh');
ERROR:  invalid input syntax for type numeric: "hhh"
LINE 1: SELECT 'hhh'::numeric;
               ^
QUERY:  SELECT 'hhh'::numeric;
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,text) line 74 at EXECUTE
select MLS_DATAMASK_CREATE('public', 'test_table_e', 'e_i', 3, 'iii');
ERROR:  invalid input syntax for type timestamp: "iii"
LINE 1: SELECT 'iii'::timestamp;
               ^
QUERY:  SELECT 'iii'::timestamp;
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,text) line 74 at EXECUTE
select MLS_DATAMASK_CREATE('public', 'test_table_e', 'e_j', 3, 'jjj');
ERROR:  invalid input syntax for type real: "jjj"
LINE 1: SELECT 'jjj'::float4;
               ^
QUERY:  SELECT 'jjj'::float4;
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,text) line 74 at EXECUTE
select MLS_DATAMASK_CREATE('public', 'test_table_e', 'e_k', 3, 'kkk');
ERROR:  invalid input syntax for type double precision: "kkk"
LINE 1: SELECT 'kkk'::float8;
               ^
QUERY:  SELECT 'kkk'::float8;
CONTEXT:  PL/pgSQL function mls_datamask_create(name,name,name,integer,text) line 74 at EXECUTE
\c - godlike
insert into test_table_e(e_a, e_b, e_c, e_d, e_e, e_f, e_g, e_h, e_i, e_j, e_k) values(111, 222, 333, 'OpenTenBase', 'OpenTenBase', 'OpenTenBase', 'OpenTenBase', '123.123', '2018-08-08 8:8:8', '444.444', ' 888.888');
insert into test_table_e(e_a, e_b, e_c, e_d, e_e, e_f, e_g, e_h, e_i, e_j, e_k) values(444, 555, 666, 'OpenTenBase', 'OpenTenBase ', 'OpenTenBase ', 'OpenTenBase ', '1234.1234', '2019-09-09 9:9:9', '444555.444555', ' 888999.888999');
insert into test_table_e(e_a, e_b, e_c, e_d, e_e, e_f, e_g, e_h, e_i, e_j, e_k) values(777, 888, 999, 'hello world', 'hello opentenbase', 'hello 700', 'hello 007', '12345.12345', '2020-10-10 10:10:10', '44456.44456', ' 8889990.888999');
select * from test_table_e order by e_a;
 e_a | e_b  | e_c  | e_d | e_e |         e_f          | e_g |     e_h     |           e_i            |   e_j   |      e_k       
-----+------+------+-----+-----+----------------------+-----+-------------+--------------------------+---------+----------------
 111 | 9999 | 9999 | ddd | eee | fff                  | ggg |     123.123 | Wed Aug 08 08:08:08 2018 | 444.444 |        888.888
 444 | 9999 | 9999 | ddd | eee | fff                  | ggg |   1234.1234 | Mon Sep 09 09:09:09 2019 |  444555 |  888999.888999
 777 | 9999 | 9999 | ddd | eee | fff                  | ggg | 12345.12345 | Sat Oct 10 10:10:10 2020 | 44456.4 | 8889990.888999
(3 rows)

\c - mls_admin
select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'test_table_e');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

\c - godlike
drop table test_table_e;
--case15: forbid detaching partition if mls policy exists
\c - godlike
drop table if exists alter_order_range;
NOTICE:  table "alter_order_range" does not exist, skipping
create table alter_order_range(f1 int, f2 int2, f3 int4, f4 int8, f5 varchar, f6 text, f7 char(20), f8 varchar, f9 numeric, f10 timestamp, f11 float4, f12 float8) partition by range (f10);
create table alter_order_range_201701 partition of alter_order_range(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) for values from ('2017-01-01') to ('2017-02-01');
create table alter_order_range_201702 partition of alter_order_range(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) for values from ('2017-02-01') to ('2017-03-01');
insert into alter_order_range(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) values(1,111, 222, 333, 'OpenTenBase', 'OpenTenBase ', 'helloworld', 'OpenTenBase', '123.123', '2017-01-02 0:0:0', '444.444', ' 888.888');
insert into alter_order_range(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) values(2,111, 222, 333, 'OpenTenBase', 'OpenTenBase ', 'helloworld', 'OpenTenBase', '123.123', '2017-02-02 0:0:0', '444.444', ' 888.888');
\c - mls_admin
select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f2', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f3', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f4', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f5', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f6', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f7', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f8', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f9', 3);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f10', 3, '2015-05-05 5:5:5');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f11', 3);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'alter_order_range', 'f12', 3);
 mls_datamask_create 
---------------------
 t
(1 row)

\c - godlike
select * from alter_order_range order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |   f6   |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+--------+----------------------+-------+------+--------------------------+------+------
  1 | 9999 | 9999 | 9999 | XXXXe | XXXXe  | XXXXoworld           | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  2 | 9999 | 9999 | 9999 | XXXXe | XXXXe  | XXXXoworld           | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(2 rows)

select * from alter_order_range_201701 order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |   f6   |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+--------+----------------------+-------+------+--------------------------+------+------
  1 | 9999 | 9999 | 9999 | XXXXe | XXXXe  | XXXXoworld           | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(1 row)

select * from alter_order_range_201702 order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |   f6   |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+--------+----------------------+-------+------+--------------------------+------+------
  2 | 9999 | 9999 | 9999 | XXXXe | XXXXe  | XXXXoworld           | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(1 row)

sample alter_order_range(3000);
 samplenum | totalnum | deadnum | totalpages | visiblepages |                                                   rows                                                   
-----------+----------+---------+------------+--------------+----------------------------------------------------------------------------------------------------------
         2 |        2 |       0 |          2 |            0 | 
           |          |         |            |              | (1,9999,9999,9999,XXXXe,"XXXXe ","XXXXoworld          ",XXXXe,9999,"Tue May 05 05:05:05 2015",9999,9999)
           |          |         |            |              | (2,9999,9999,9999,XXXXe,"XXXXe ","XXXXoworld          ",XXXXe,9999,"Tue May 05 05:05:05 2015",9999,9999)
(3 rows)

alter table alter_order_range detach partition alter_order_range_201701;
ERROR:  could not detach partition for table:alter_order_range, cause mls poilcy is bound
\c - mls_admin
select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'alter_order_range');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

--fails
\c - godlike
drop table alter_order_range;
ERROR:  could not drop table:alter_order_range, cause mls poilcy is bound
\c - mls_admin
select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'alter_order_range_201701');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'alter_order_range_201702');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

--success
\c - godlike 
drop table alter_order_range;
--case16: drop all column policies of the 'white list user' in batch
\c - mls_admin
select attnum,enable,username,nspname,tblname from pg_data_mask_user order by tblname, username, attnum;
 attnum | enable | username | nspname |     tblname     
--------+--------+----------+---------+-----------------
      4 | t      | godlike  | public  | tbl_datamask_xx
      6 | t      | godlike  | public  | tbl_datamask_xx
     10 | t      | godlike  | public  | tbl_datamask_xx
     -1 | t      | godlike2 | public  | tbl_datamask_xx
      2 | t      | godlike  | public  | tbl_xx
      3 | t      | godlike  | public  | tbl_xx
      4 | t      | godlike  | public  | tbl_xx
      5 | t      | godlike  | public  | tbl_xx
      6 | t      | godlike  | public  | tbl_xx
      7 | t      | godlike  | public  | tbl_xx
      8 | t      | godlike  | public  | tbl_xx
     10 | t      | godlike  | public  | tbl_xx
(12 rows)

\c - godlike
create table tbl_drop_white_list_by_col(f1 int, f2 int2, f3 int4, f4 int8) distribute by shard (f1);
create table tbl_drop_white_list_batch(f1 int, f2 int2, f3 int4, f4 int8) distribute by shard (f1);
\c - mls_admin
select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_drop_white_list_by_col', 'f2', 'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_drop_white_list_by_col', 'f3', 'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_drop_white_list_by_col', 'f4', 'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'tbl_drop_white_list_batch',  'godlike');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select attnum,enable,username,nspname,tblname from pg_data_mask_user order by tblname, username, attnum;
 attnum | enable | username | nspname |          tblname           
--------+--------+----------+---------+----------------------------
      4 | t      | godlike  | public  | tbl_datamask_xx
      6 | t      | godlike  | public  | tbl_datamask_xx
     10 | t      | godlike  | public  | tbl_datamask_xx
     -1 | t      | godlike2 | public  | tbl_datamask_xx
     -1 | t      | godlike  | public  | tbl_drop_white_list_batch
      2 | t      | godlike  | public  | tbl_drop_white_list_by_col
      3 | t      | godlike  | public  | tbl_drop_white_list_by_col
      4 | t      | godlike  | public  | tbl_drop_white_list_by_col
      2 | t      | godlike  | public  | tbl_xx
      3 | t      | godlike  | public  | tbl_xx
      4 | t      | godlike  | public  | tbl_xx
      5 | t      | godlike  | public  | tbl_xx
      6 | t      | godlike  | public  | tbl_xx
      7 | t      | godlike  | public  | tbl_xx
      8 | t      | godlike  | public  | tbl_xx
     10 | t      | godlike  | public  | tbl_xx
(16 rows)

select MLS_DATAMASK_DROP_USER_POLICY('public', 'tbl_drop_white_list_by_col',  'godlike');
 mls_datamask_drop_user_policy 
-------------------------------
 t
(1 row)

select MLS_DATAMASK_DROP_USER_POLICY('public', 'tbl_drop_white_list_batch',  'godlike');
 mls_datamask_drop_user_policy 
-------------------------------
 t
(1 row)

select attnum,enable,username,nspname,tblname from pg_data_mask_user order by tblname, username, attnum;
 attnum | enable | username | nspname |     tblname     
--------+--------+----------+---------+-----------------
      4 | t      | godlike  | public  | tbl_datamask_xx
      6 | t      | godlike  | public  | tbl_datamask_xx
     10 | t      | godlike  | public  | tbl_datamask_xx
     -1 | t      | godlike2 | public  | tbl_datamask_xx
      2 | t      | godlike  | public  | tbl_xx
      3 | t      | godlike  | public  | tbl_xx
      4 | t      | godlike  | public  | tbl_xx
      5 | t      | godlike  | public  | tbl_xx
      6 | t      | godlike  | public  | tbl_xx
      7 | t      | godlike  | public  | tbl_xx
      8 | t      | godlike  | public  | tbl_xx
     10 | t      | godlike  | public  | tbl_xx
(12 rows)

\c - godlike
drop table tbl_drop_white_list_by_col;
drop table tbl_drop_white_list_batch;
--case: orignal partitions would bind datamask to its children all, cover L1\L2\Lx....
drop table if exists order_range_list;
NOTICE:  table "order_range_list" does not exist, skipping
create table order_range_list(f1 int, f2 int2, f3 int4, f4 int8, f5 varchar, f6 text, f7 char(20), f8 varchar, f9 numeric, f10 timestamp, f11 float4, f12 float8) partition by list (f6);
create table order_range_list_gd partition of order_range_list for values in ('gd') partition by range (f10);
create table order_range_list_bj partition of order_range_list for values in ('bj') partition by range (f10);
create table order_range_list_sh partition of order_range_list for values in ('sh');
create table order_range_list_gd_201701 partition of order_range_list_gd(f1 primary key,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) for values from ('2017-01-01') to ('2017-02-01');
create table order_range_list_gd_201702 partition of order_range_list_gd(f1 primary key,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) for values from ('2017-02-01') to ('2017-03-01');
create table order_range_list_gd_201703 partition of order_range_list_gd(f1 primary key,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) for values from ('2017-03-01') to ('2017-04-01');
create table order_range_list_bj_201701 partition of order_range_list_bj(f1 primary key,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) for values from ('2017-01-01') to ('2017-02-01');
create table order_range_list_bj_201702 partition of order_range_list_bj(f1 primary key,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) for values from ('2017-02-01') to ('2017-03-01');
create table order_range_list_bj_201703 partition of order_range_list_bj(f1 primary key,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) for values from ('2017-03-01') to ('2017-04-01');
insert into order_range_list(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) values(1,111, 222, 333, 'OpenTenBase', 'gd', 'hello opentenbase ', 'OpenTenBase', '123.123', '2017-01-02 0:0:0', '444.444', ' 888.888');
insert into order_range_list(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) values(2,111, 222, 333, 'OpenTenBase', 'gd', 'hello opentenbase ', 'OpenTenBase', '123.123', '2017-02-02 0:0:0', '444.444', ' 888.888');
insert into order_range_list(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) values(3,111, 222, 333, 'OpenTenBase', 'gd', 'hello opentenbase ', 'OpenTenBase', '123.123', '2017-03-02 0:0:0', '444.444', ' 888.888');
insert into order_range_list(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) values(4,111, 222, 333, 'OpenTenBase', 'bj', 'hello beijing', 'OpenTenBase', '123.123', '2017-01-02 0:0:0', '444.444', ' 888.888');
insert into order_range_list(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) values(5,111, 222, 333, 'OpenTenBase', 'bj', 'hello beijing', 'OpenTenBase', '123.123', '2017-02-02 0:0:0', '444.444', ' 888.888');
insert into order_range_list(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) values(6,111, 222, 333, 'OpenTenBase', 'bj', 'hello beijing', 'OpenTenBase', '123.123', '2017-03-02 0:0:0', '444.444', ' 888.888');
insert into order_range_list(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) values(7,111, 222, 333, 'OpenTenBase', 'sh', 'hello tailand', 'OpenTenBase', '123.123', '2017-02-02 0:0:0', '444.444', ' 888.888');
insert into order_range_list(f1,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) values(8,111, 222, 333, 'OpenTenBase', 'sh', 'hello tailand', 'OpenTenBase', '123.123', '2017-01-02 0:0:0', '444.444', ' 888.888');
\c - mls_admin
select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f2', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f3', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f4', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f5', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f6', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f7', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f8', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f9', 3);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f10', 3, '2015-05-05 5:5:5');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f11', 3);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'f12', 3);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f2',  'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f3',  'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f4',  'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f5',  'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f6',  'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f7',  'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f8',  'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f9',  'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f10', 'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f11', 'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

select MLS_DATAMASK_CREATE_USER_POLICY('public', 'order_range_list', 'f12', 'godlike2');
 mls_datamask_create_user_policy 
---------------------------------
 t
(1 row)

--mask values
\c - godlike
select * from order_range_list order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |  f6  |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+------+----------------------+-------+------+--------------------------+------+------
  1 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo opentenbase          | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  2 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo opentenbase          | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  3 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo opentenbase          | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  4 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo beijing        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  5 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo beijing        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  6 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo beijing        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  7 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo tailand        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  8 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo tailand        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(8 rows)

select * from order_range_list_gd order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |  f6  |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+------+----------------------+-------+------+--------------------------+------+------
  1 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo opentenbase          | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  2 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo opentenbase          | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  3 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo opentenbase          | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(3 rows)

select * from order_range_list_bj order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |  f6  |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+------+----------------------+-------+------+--------------------------+------+------
  4 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo beijing        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  5 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo beijing        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  6 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo beijing        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(3 rows)

select * from order_range_list_sh order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |  f6  |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+------+----------------------+-------+------+--------------------------+------+------
  7 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo tailand        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
  8 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo tailand        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(2 rows)

select * from order_range_list_gd_201701 order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |  f6  |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+------+----------------------+-------+------+--------------------------+------+------
  1 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo opentenbase          | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(1 row)

select * from order_range_list_gd_201702 order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |  f6  |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+------+----------------------+-------+------+--------------------------+------+------
  2 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo opentenbase          | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(1 row)

select * from order_range_list_gd_201703 order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |  f6  |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+------+----------------------+-------+------+--------------------------+------+------
  3 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo opentenbase          | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(1 row)

select * from order_range_list_bj_201701 order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |  f6  |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+------+----------------------+-------+------+--------------------------+------+------
  4 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo beijing        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(1 row)

select * from order_range_list_bj_201702 order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |  f6  |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+------+----------------------+-------+------+--------------------------+------+------
  5 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo beijing        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(1 row)

select * from order_range_list_bj_201703 order by f1 asc;
 f1 |  f2  |  f3  |  f4  |  f5   |  f6  |          f7          |  f8   |  f9  |           f10            | f11  | f12  
----+------+------+------+-------+------+----------------------+-------+------+--------------------------+------+------
  6 | 9999 | 9999 | 9999 | XXXXe | XXXX | XXXXo beijing        | XXXXe | 9999 | Tue May 05 05:05:05 2015 | 9999 | 9999
(1 row)

--orignal values
\c - godlike2
select * from order_range_list order by f1 asc;
 f1 | f2  | f3  | f4  |  f5   | f6 |          f7          |  f8   |   f9    |           f10            |   f11   |   f12   
----+-----+-----+-----+-------+----+----------------------+-------+---------+--------------------------+---------+---------
  1 | 111 | 222 | 333 | OpenTenBase | gd | hello opentenbase          | OpenTenBase | 123.123 | Mon Jan 02 00:00:00 2017 | 444.444 | 888.888
  2 | 111 | 222 | 333 | OpenTenBase | gd | hello opentenbase          | OpenTenBase | 123.123 | Thu Feb 02 00:00:00 2017 | 444.444 | 888.888
  3 | 111 | 222 | 333 | OpenTenBase | gd | hello opentenbase          | OpenTenBase | 123.123 | Thu Mar 02 00:00:00 2017 | 444.444 | 888.888
  4 | 111 | 222 | 333 | OpenTenBase | bj | hello beijing        | OpenTenBase | 123.123 | Mon Jan 02 00:00:00 2017 | 444.444 | 888.888
  5 | 111 | 222 | 333 | OpenTenBase | bj | hello beijing        | OpenTenBase | 123.123 | Thu Feb 02 00:00:00 2017 | 444.444 | 888.888
  6 | 111 | 222 | 333 | OpenTenBase | bj | hello beijing        | OpenTenBase | 123.123 | Thu Mar 02 00:00:00 2017 | 444.444 | 888.888
  7 | 111 | 222 | 333 | OpenTenBase | sh | hello tailand        | OpenTenBase | 123.123 | Thu Feb 02 00:00:00 2017 | 444.444 | 888.888
  8 | 111 | 222 | 333 | OpenTenBase | sh | hello tailand        | OpenTenBase | 123.123 | Mon Jan 02 00:00:00 2017 | 444.444 | 888.888
(8 rows)

select * from order_range_list_gd order by f1 asc;
 f1 | f2  | f3  | f4  |  f5   | f6 |          f7          |  f8   |   f9    |           f10            |   f11   |   f12   
----+-----+-----+-----+-------+----+----------------------+-------+---------+--------------------------+---------+---------
  1 | 111 | 222 | 333 | OpenTenBase | gd | hello opentenbase          | OpenTenBase | 123.123 | Mon Jan 02 00:00:00 2017 | 444.444 | 888.888
  2 | 111 | 222 | 333 | OpenTenBase | gd | hello opentenbase          | OpenTenBase | 123.123 | Thu Feb 02 00:00:00 2017 | 444.444 | 888.888
  3 | 111 | 222 | 333 | OpenTenBase | gd | hello opentenbase          | OpenTenBase | 123.123 | Thu Mar 02 00:00:00 2017 | 444.444 | 888.888
(3 rows)

select * from order_range_list_bj order by f1 asc;
 f1 | f2  | f3  | f4  |  f5   | f6 |          f7          |  f8   |   f9    |           f10            |   f11   |   f12   
----+-----+-----+-----+-------+----+----------------------+-------+---------+--------------------------+---------+---------
  4 | 111 | 222 | 333 | OpenTenBase | bj | hello beijing        | OpenTenBase | 123.123 | Mon Jan 02 00:00:00 2017 | 444.444 | 888.888
  5 | 111 | 222 | 333 | OpenTenBase | bj | hello beijing        | OpenTenBase | 123.123 | Thu Feb 02 00:00:00 2017 | 444.444 | 888.888
  6 | 111 | 222 | 333 | OpenTenBase | bj | hello beijing        | OpenTenBase | 123.123 | Thu Mar 02 00:00:00 2017 | 444.444 | 888.888
(3 rows)

select * from order_range_list_sh order by f1 asc;
 f1 | f2  | f3  | f4  |  f5   | f6 |          f7          |  f8   |   f9    |           f10            |   f11   |   f12   
----+-----+-----+-----+-------+----+----------------------+-------+---------+--------------------------+---------+---------
  7 | 111 | 222 | 333 | OpenTenBase | sh | hello tailand        | OpenTenBase | 123.123 | Thu Feb 02 00:00:00 2017 | 444.444 | 888.888
  8 | 111 | 222 | 333 | OpenTenBase | sh | hello tailand        | OpenTenBase | 123.123 | Mon Jan 02 00:00:00 2017 | 444.444 | 888.888
(2 rows)

select * from order_range_list_gd_201701 order by f1 asc;
 f1 | f2  | f3  | f4  |  f5   | f6 |          f7          |  f8   |   f9    |           f10            |   f11   |   f12   
----+-----+-----+-----+-------+----+----------------------+-------+---------+--------------------------+---------+---------
  1 | 111 | 222 | 333 | OpenTenBase | gd | hello opentenbase          | OpenTenBase | 123.123 | Mon Jan 02 00:00:00 2017 | 444.444 | 888.888
(1 row)

select * from order_range_list_gd_201702 order by f1 asc;
 f1 | f2  | f3  | f4  |  f5   | f6 |          f7          |  f8   |   f9    |           f10            |   f11   |   f12   
----+-----+-----+-----+-------+----+----------------------+-------+---------+--------------------------+---------+---------
  2 | 111 | 222 | 333 | OpenTenBase | gd | hello opentenbase          | OpenTenBase | 123.123 | Thu Feb 02 00:00:00 2017 | 444.444 | 888.888
(1 row)

select * from order_range_list_gd_201703 order by f1 asc;
 f1 | f2  | f3  | f4  |  f5   | f6 |          f7          |  f8   |   f9    |           f10            |   f11   |   f12   
----+-----+-----+-----+-------+----+----------------------+-------+---------+--------------------------+---------+---------
  3 | 111 | 222 | 333 | OpenTenBase | gd | hello opentenbase          | OpenTenBase | 123.123 | Thu Mar 02 00:00:00 2017 | 444.444 | 888.888
(1 row)

select * from order_range_list_bj_201701 order by f1 asc;
 f1 | f2  | f3  | f4  |  f5   | f6 |          f7          |  f8   |   f9    |           f10            |   f11   |   f12   
----+-----+-----+-----+-------+----+----------------------+-------+---------+--------------------------+---------+---------
  4 | 111 | 222 | 333 | OpenTenBase | bj | hello beijing        | OpenTenBase | 123.123 | Mon Jan 02 00:00:00 2017 | 444.444 | 888.888
(1 row)

select * from order_range_list_bj_201702 order by f1 asc;
 f1 | f2  | f3  | f4  |  f5   | f6 |          f7          |  f8   |   f9    |           f10            |   f11   |   f12   
----+-----+-----+-----+-------+----+----------------------+-------+---------+--------------------------+---------+---------
  5 | 111 | 222 | 333 | OpenTenBase | bj | hello beijing        | OpenTenBase | 123.123 | Thu Feb 02 00:00:00 2017 | 444.444 | 888.888
(1 row)

select * from order_range_list_bj_201703 order by f1 asc;
 f1 | f2  | f3  | f4  |  f5   | f6 |          f7          |  f8   |   f9    |           f10            |   f11   |   f12   
----+-----+-----+-----+-------+----+----------------------+-------+---------+--------------------------+---------+---------
  6 | 111 | 222 | 333 | OpenTenBase | bj | hello beijing        | OpenTenBase | 123.123 | Thu Mar 02 00:00:00 2017 | 444.444 | 888.888
(1 row)

--clean
\c - mls_admin
select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'order_range_list');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'order_range_list_bj');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'order_range_list_sh');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'order_range_list_gd');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

--fail to clean all
select tblname, datamask, attnum from pg_data_mask_map where tblname ilike 'order_range_list%' order by 1, 2, 3;
          tblname           | datamask | attnum 
----------------------------+----------+--------
 order_range_list_bj_201701 |        0 |     10
 order_range_list_bj_201701 |        4 |      5
 order_range_list_bj_201701 |        4 |      6
 order_range_list_bj_201701 |        4 |      7
 order_range_list_bj_201701 |        4 |      8
 order_range_list_bj_201701 |     9999 |      2
 order_range_list_bj_201701 |     9999 |      3
 order_range_list_bj_201701 |     9999 |      4
 order_range_list_bj_201701 |     9999 |      9
 order_range_list_bj_201701 |     9999 |     11
 order_range_list_bj_201701 |     9999 |     12
 order_range_list_bj_201702 |        0 |     10
 order_range_list_bj_201702 |        4 |      5
 order_range_list_bj_201702 |        4 |      6
 order_range_list_bj_201702 |        4 |      7
 order_range_list_bj_201702 |        4 |      8
 order_range_list_bj_201702 |     9999 |      2
 order_range_list_bj_201702 |     9999 |      3
 order_range_list_bj_201702 |     9999 |      4
 order_range_list_bj_201702 |     9999 |      9
 order_range_list_bj_201702 |     9999 |     11
 order_range_list_bj_201702 |     9999 |     12
 order_range_list_bj_201703 |        0 |     10
 order_range_list_bj_201703 |        4 |      5
 order_range_list_bj_201703 |        4 |      6
 order_range_list_bj_201703 |        4 |      7
 order_range_list_bj_201703 |        4 |      8
 order_range_list_bj_201703 |     9999 |      2
 order_range_list_bj_201703 |     9999 |      3
 order_range_list_bj_201703 |     9999 |      4
 order_range_list_bj_201703 |     9999 |      9
 order_range_list_bj_201703 |     9999 |     11
 order_range_list_bj_201703 |     9999 |     12
 order_range_list_gd_201701 |        0 |     10
 order_range_list_gd_201701 |        4 |      5
 order_range_list_gd_201701 |        4 |      6
 order_range_list_gd_201701 |        4 |      7
 order_range_list_gd_201701 |        4 |      8
 order_range_list_gd_201701 |     9999 |      2
 order_range_list_gd_201701 |     9999 |      3
 order_range_list_gd_201701 |     9999 |      4
 order_range_list_gd_201701 |     9999 |      9
 order_range_list_gd_201701 |     9999 |     11
 order_range_list_gd_201701 |     9999 |     12
 order_range_list_gd_201702 |        0 |     10
 order_range_list_gd_201702 |        4 |      5
 order_range_list_gd_201702 |        4 |      6
 order_range_list_gd_201702 |        4 |      7
 order_range_list_gd_201702 |        4 |      8
 order_range_list_gd_201702 |     9999 |      2
 order_range_list_gd_201702 |     9999 |      3
 order_range_list_gd_201702 |     9999 |      4
 order_range_list_gd_201702 |     9999 |      9
 order_range_list_gd_201702 |     9999 |     11
 order_range_list_gd_201702 |     9999 |     12
 order_range_list_gd_201703 |        0 |     10
 order_range_list_gd_201703 |        4 |      5
 order_range_list_gd_201703 |        4 |      6
 order_range_list_gd_201703 |        4 |      7
 order_range_list_gd_201703 |        4 |      8
 order_range_list_gd_201703 |     9999 |      2
 order_range_list_gd_201703 |     9999 |      3
 order_range_list_gd_201703 |     9999 |      4
 order_range_list_gd_201703 |     9999 |      9
 order_range_list_gd_201703 |     9999 |     11
 order_range_list_gd_201703 |     9999 |     12
(66 rows)

--use casecade
select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'order_range_list', true);
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

--there is no user policy too
select tblname , username, attnum from pg_data_mask_user where tblname ilike 'order_range_list%' order by 1, 2,3;
 tblname | username | attnum 
---------+----------+--------
(0 rows)

\c - godlike
drop table order_range_list;
---test for MLS_DATAMASK_UPDATE_TABLE_POLICY
\c - godlike 
create table test_table_mask_update(id int, f1 int2, f2 int4, f3 int8, f4 varchar, f5 text, f6 char(20), f7 varchar, f8 numeric, f9 timestamp, f10 float4, f11 float8, f12 varchar, f13 text, f14 char(20), f15 varchar);
insert into test_table_mask_update values(1, 2, 3,4, 'a','b','c','d',5,'2018-01-01',6,7,'e','f','g','h');
select * from test_table_mask_update;
 id | f1 | f2 | f3 | f4 | f5 |          f6          | f7 | f8 |            f9            | f10 | f11 | f12 | f13 |         f14          | f15 
----+----+----+----+----+----+----------------------+----+----+--------------------------+-----+-----+-----+-----+----------------------+-----
  1 |  2 |  3 |  4 | a  | b  | c                    | d  |  5 | Mon Jan 01 00:00:00 2018 |   6 |   7 | e   | f   | g                    | h
(1 row)

\c - mls_admin
select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f1', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f2', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f3', 1);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f4', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f5', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f6', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f7', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f12', 4);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f13', 4);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f14', 4);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f15', 4);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f8', 3);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f9', 3, '2018-05-30 15:16:57');
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f10', 3);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'test_table_mask_update', 'f11', 3);
 mls_datamask_create 
---------------------
 t
(1 row)

\c - godlike
select * from test_table_mask_update;
 id |  f1  |  f2  |  f3  |  f4  |  f5  |          f6          |  f7  |  f8  |            f9            | f10  | f11  | f12  | f13  |         f14          | f15  
----+------+------+------+------+------+----------------------+------+------+--------------------------+------+------+------+------+----------------------+------
  1 | 9999 | 9999 | 9999 | XXXX | XXXX | XXXX                 | XXXX | 9999 | Wed May 30 15:16:57 2018 | 9999 | 9999 | XXXX | XXXX | g               XXXX | XXXX
(1 row)

\c - mls_admin
select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f1', 666);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f2', 777);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f3', 888);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f4', 6);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f5', 6);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f6', 6);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f7', 6);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f12', 5);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f13', 5);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f14', 5);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f15', 5);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f8', 3);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f9', '1970-01-01');
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f10', 3);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'test_table_mask_update', 'f11', 3);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

\c - godlike
select * from test_table_mask_update;
 id | f1  | f2  | f3  |   f4   |   f5   |          f6          |   f7   | f8 |            f9            | f10 | f11 |  f12  |  f13  |         f14          |  f15  
----+-----+-----+-----+--------+--------+----------------------+--------+----+--------------------------+-----+-----+-------+-------+----------------------+-------
  1 | 666 | 777 | 888 | XXXXXX | XXXXXX | XXXXXX               | XXXXXX |  3 | Thu Jan 01 00:00:00 1970 |   3 |   3 | XXXXX | XXXXX | g              XXXXX | XXXXX
(1 row)

\c - mls_admin
select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'test_table_mask_update');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

\c - godlike
drop  table  test_table_mask_update;
--test for MLS_DATAMASK_UPDATE_TABLE_POLICY with orignal partition
\c - godlike
create table order_range_list(id bigserial not null,userid integer,product text,area text, createdate timestamp) partition by list ( area );
create table order_range_list_gd partition of order_range_list for values in ('guangdong') partition by range(createdate); 
create table order_range_list_gd_201701 partition of order_range_list_gd(id primary key,userid,product,area,createdate) for values from ('2017-01-01') to ('2017-02-01'); 
\c - mls_admin
select MLS_DATAMASK_CREATE('public', 'order_range_list', 'area', 2);
 mls_datamask_create 
---------------------
 t
(1 row)

select MLS_DATAMASK_CREATE('public', 'order_range_list', 'createdate', 3, '1970-01-01');
 mls_datamask_create 
---------------------
 t
(1 row)

select attnum, option, datamask, tblname, defaultval from pg_data_mask_map where tblname ilike 'order_range_list%' order by 1,2,3,4,5;
 attnum | option | datamask |          tblname           | defaultval 
--------+--------+----------+----------------------------+------------
      4 |      2 |        4 | order_range_list           | 9999
      4 |      2 |        4 | order_range_list_gd        | 9999
      4 |      2 |        4 | order_range_list_gd_201701 | 9999
      5 |      3 |        0 | order_range_list           | 1970-01-01
      5 |      3 |        0 | order_range_list_gd        | 1970-01-01
      5 |      3 |        0 | order_range_list_gd_201701 | 1970-01-01
(6 rows)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'order_range_list', 'area', 6);
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select MLS_DATAMASK_UPDATE_TABLE_POLICY('public', 'order_range_list', 'createdate', '2999-9-9');
 mls_datamask_update_table_policy 
----------------------------------
 t
(1 row)

select attnum, option, datamask, tblname, defaultval from pg_data_mask_map where tblname ilike 'order_range_list%' order by 1,2,3,4,5;
 attnum | option | datamask |          tblname           | defaultval 
--------+--------+----------+----------------------------+------------
      4 |      2 |        6 | order_range_list           | 9999
      4 |      2 |        6 | order_range_list_gd        | 9999
      4 |      2 |        6 | order_range_list_gd_201701 | 9999
      5 |      3 |        0 | order_range_list           | 2999-9-9
      5 |      3 |        0 | order_range_list_gd        | 2999-9-9
      5 |      3 |        0 | order_range_list_gd_201701 | 2999-9-9
(6 rows)

select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'order_range_list', true);
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

select attnum, option, datamask, tblname, defaultval from pg_data_mask_map where tblname ilike 'order_range_list%' order by 1,2,3,4,5;
 attnum | option | datamask | tblname | defaultval 
--------+--------+----------+---------+------------
(0 rows)

\c - godlike
drop table order_range_list;
--done all------------------------------------
\c regression godlike
drop table tbl_datamask_xx;
ERROR:  could not drop table:tbl_datamask_xx, cause mls poilcy is bound
drop table tbl_datamask_yy;
drop table tbl_datamask_zz;
drop table tbl_xx;
ERROR:  could not drop table:tbl_xx, cause mls poilcy is bound
drop table tbl_datamask_shard_part;
ERROR:  could not drop table:tbl_datamask_shard_part, cause mls poilcy is bound
drop table data_mask_primary_key;
truncate tbl_xx;
\c - mls_admin
select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'tbl_xx');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'tbl_datamask_shard_part');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

select MLS_DATAMASK_DROP_TABLE_POLICY('public', 'tbl_datamask_xx');
 mls_datamask_drop_table_policy 
--------------------------------
 t
(1 row)

\c - godlike
drop table tbl_xx;
drop table tbl_datamask_xx;
drop table tbl_datamask_shard_part;
-----------------DATAMASK TEST END--------------------
-----------------TRANSPARENT CRYPT TEST BEGIN--------------------
--prepare
\c regression godlike
create table xx( i int, i_m int, ii int2, ii_m int2, j bigint, j_m bigint, x varchar, x_m varchar, y text, y_m text);
create table yy( i int, i_m int, ii int2, ii_m int2, j bigint, j_m bigint, x varchar, x_m varchar, y text, y_m text);
insert into yy values(1024, 1024, 7788, 7788, 42949672960,42949672960, '112233201804035566', '112233201804035566', 'abcdefghijk', 'abcdefghijk');
create table zz ( i int , j char , z char );
insert into zz values(1024,'x','y');
--create crypt algorithm
\c regression mls_admin
select MLS_TRANSPARENT_CRYPT_CREATE_ALGORITHM('AES128', '8888');
 mls_transparent_crypt_create_algorithm 
----------------------------------------
                                      1
(1 row)

select MLS_TRANSPARENT_CRYPT_CREATE_ALGORITHM('AES192', '7777');
 mls_transparent_crypt_create_algorithm 
----------------------------------------
                                      2
(1 row)

select MLS_TRANSPARENT_CRYPT_CREATE_ALGORITHM('AES256', '6666');
 mls_transparent_crypt_create_algorithm 
----------------------------------------
                                      3
(1 row)

select MLS_TRANSPARENT_CRYPT_CREATE_ALGORITHM('SM4', '123456789abcdefg');
 mls_transparent_crypt_create_algorithm 
----------------------------------------
                                      4
(1 row)

--binding crypt policy to table
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'xx', 'x_m', 1);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'xx', 'y_m', 3);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

--fail, dup bind
--select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'xx', 'x_m', 2);
--case1: check result, all in decrypt datum value
\c regression godlike
insert into xx values(1024, 1024, 7788, 7788, 42949672960,42949672960, '112233201804035566', '112233201804035566', 'abcdefghijk', 'abcdefghijk');
insert into xx(i, x) values(1025, 'all is null');
select * from xx order by i;
  i   | i_m  |  ii  | ii_m |      j      |     j_m     |         x          |        x_m         |      y      |     y_m     
------+------+------+------+-------------+-------------+--------------------+--------------------+-------------+-------------
 1024 | 1024 | 7788 | 7788 | 42949672960 | 42949672960 | 112233201804035566 | 112233201804035566 | abcdefghijk | abcdefghijk
 1025 |      |      |      |             |             | all is null        |                    |             | 
(2 rows)

--fail, there are recode in table xx
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'xx', 'x_m');
ERROR:  table_name:public.xx is not empty, please TRUNCATE table and try again
CONTEXT:  PL/pgSQL function mls_transparent_crypt_algorithm_unbind_table(name,name,name,boolean) line 32 at RAISE
--fail, if table is not empty, can not bind crypt algo
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'xx', 'j_m', 2);
ERROR:  table_name:public.xx is not empty
CONTEXT:  PL/pgSQL function mls_transparent_crypt_algorithm_bind_table(name,name,name,integer) line 51 at RAISE
--fail, system table is unsupported
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('pg_catalog', 'pg_database', 'datconnlimit', 1);
ERROR:  system table:pg_database is unsupported
CONTEXT:  PL/pgSQL function mls_transparent_crypt_algorithm_bind_table(name,name,name,integer) line 37 at RAISE
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('pg_catalog', 'pg_database', 1);
ERROR:  system table:pg_database is unsupported
CONTEXT:  PL/pgSQL function mls_transparent_crypt_algorithm_bind_table(name,name,integer) line 35 at RAISE
--case2: we arrange var-length and fix-length datatype mixed with each other
\c regression godlike
create table tbl_complex(i int, x text, j smallint, y varchar, k bigint, z text, o text, t timestamp, f4 float4, f8 float8, n1 numeric, var2 varchar, c1 char, c2 char(3));
\c  regression mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'i');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'x');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'j');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'y');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'k');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'z');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'o');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 't');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'f4');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'f8');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'n1');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'var2');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'c1');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'c2');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'i', 1);
ERROR:  distribute key could not bind crypt, public.tbl_complex attrname:i
CONTEXT:  PL/pgSQL function mls_transparent_crypt_algorithm_bind_table(name,name,name,integer) line 44 at RAISE
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'x', 2);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'j', 3);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'y', 1);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'k', 2);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'z', 3);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'o', 1);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 't', 2);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'f4',3);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'f8',   1);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'n1',   2);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'var2', 3);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'c1', 1);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 'c2', 2);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex', 1);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

--check the result                                                               
\c regression godlike
insert into tbl_complex values(1024, 'xyz', 4499, 'abcdefg', 8877, 'this is blanc', 'rock and rooo~~', '2018-08-08 8:8:8', 111.11, 1234567890.123, 987654321.123, 'this is a varchar2 string', 'p', 'dp');
insert into tbl_complex(i) values(1025);
select * from tbl_complex order by i;
  i   |  x  |  j   |    y    |  k   |       z       |        o        |            t             |   f4   |       f8       |      n1       |           var2            | c1 | c2  
------+-----+------+---------+------+---------------+-----------------+--------------------------+--------+----------------+---------------+---------------------------+----+-----
 1024 | xyz | 4499 | abcdefg | 8877 | this is blanc | rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
 1025 |     |      |         |      |               |                 |                          |        |                |               |                           |    | 
(2 rows)

delete from tbl_complex;
--case3: fail: unsupported datatype to bind crypt policy, that shoule be failed
\c regression godlike
create table tbl_transparent_unsupport(i int, bb point);
\c regression mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_transparent_unsupport', 'bb', 1);
ERROR:  INVALID INPUT:unsupported datatype, table:public.tbl_transparent_unsupport, attribute name:bb
CONTEXT:  PL/pgSQL function mls_transparent_crypt_algorithm_bind_table(name,name,name,integer) line 64 at RAISE
\c regression godlike
insert into tbl_transparent_unsupport values(1024, '(0.0,0.0)');
select * from tbl_transparent_unsupport order by i;
  i   |  bb   
------+-------
 1024 | (0,0)
(1 row)

\c regression mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_transparent_unsupport', 'bb');
ERROR:  table_name:public.tbl_transparent_unsupport is not empty, please TRUNCATE table and try again
CONTEXT:  PL/pgSQL function mls_transparent_crypt_algorithm_unbind_table(name,name,name,boolean) line 32 at RAISE
--case4: drop crypt policy on table, while, that should be forbidden, now returning messy code
--select TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'x');
--select TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'y');
--select TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'z');
--select TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'k');
--\c regression godlike
--select * from tbl_complex;
--case, algo can not be drop if it was used
select MLS_TRANSPARENT_CRYPT_DROP_ALGORITHM(1);
ERROR:  INVALID INPUT:algo_name:AES128-algo_id:1 already in use, (spcname:pg_default,nspname:public,tblname:xx)=
CONTEXT:  PL/pgSQL function mls_transparent_crypt_drop_algorithm(integer) line 20 at RAISE
--case: interval partition with index
\c - godlike 
--create extension opentenbase_mls;
--create default node group default_group with(datanode_1, datanode_2); 
--create sharding group to group default_group;
create table tbl_mls_test(f1 int, f2 timestamp default now(), f3 int) 
partition by range (f2) 
    begin (timestamp without time zone '2018-01-01 0:0:0') step (interval '1 month') 
    partitions (3) 
    distribute by shard(f1) 
to group default_group ; 
alter table tbl_mls_test add partitions 1;
create table tbl_mls_test22(f1 int, f2 timestamp default now(), f3 int) 
partition by range (f2) 
    begin (timestamp without time zone '2018-01-01 0:0:0') step (interval '1 month') 
    partitions (3) 
    distribute by shard(f1) 
to group default_group ; 
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_mls_test', 1);
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

\c - godlike 
insert into tbl_mls_test values(1024, '2018-01-01', 1111);
insert into tbl_mls_test values(1024, '2018-02-01', 1111);
insert into tbl_mls_test values(1024, '2018-03-01', 1111);
insert into tbl_mls_test values(1024, '2018-04-01', 1111);
create index idx_tbl_mls_test on tbl_mls_test(f1, f3);
alter table tbl_mls_test add partitions 1;
insert into tbl_mls_test select generate_series(1, 10000), '2018-05-01', generate_series(1, 10000);
insert into tbl_mls_test select generate_series(1, 10), '2018-06-01', generate_series(1, 10);
ERROR:  inserted value is not in range of partitioned table, please check the value of paritition key
insert into tbl_mls_test22 values(1024, '2018-01-01', 1111);
insert into tbl_mls_test22 values(1024, '2018-02-01', 1111);
insert into tbl_mls_test22 values(1024, '2018-03-01', 1111);
insert into tbl_mls_test22 values(1024, '2018-04-01', 1111);
ERROR:  value to inserted execeed range of partitioned table
create index idx_tbl_mls_test22 on tbl_mls_test22(f1, f3);
alter table tbl_mls_test22 add partitions 2;
insert into tbl_mls_test22 select generate_series(1, 10000), '2018-05-01', generate_series(1, 10000);
insert into tbl_mls_test22 select generate_series(1, 10), '2018-06-01', generate_series(1, 10);
ERROR:  inserted value is not in range of partitioned table, please check the value of paritition key
checkpoint;
--explain select * from tbl_mls_test where f1 = 1024 and f2 >= '2018-05-01' and f2 < '2018-06-01' order by f1 limit 10 ;      
select * from tbl_mls_test where f1 = 1024 and f2 >= '2018-05-01' and f2 < '2018-06-01' order by f1 limit 10 ;      
  f1  |            f2            |  f3  
------+--------------------------+------
 1024 | Tue May 01 00:00:00 2018 | 1024
(1 row)

-- test vacuum analyze
vacuum analyze tbl_mls_test;
--case: orignal partition, interval partition with index
\c - godlike
create table tbl_mls_part_list( a int ,b int ) PARTITION BY LIST (b) ;
CREATE TABLE tbl_mls_part_list_1 PARTITION OF tbl_mls_part_list FOR VALUES IN (1);
CREATE TABLE tbl_mls_part_list_2 PARTITION OF tbl_mls_part_list FOR VALUES IN (2); 
CREATE TABLE tbl_mls_part_list_3 PARTITION OF tbl_mls_part_list FOR VALUES IN (3);
CREATE TABLE tbl_mls_part_list_4 PARTITION OF tbl_mls_part_list FOR VALUES IN (4); 
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_mls_part_list',2); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

\c - godlike
insert into tbl_mls_part_list select   generate_series(1, 1000), 1;
create index idx_tbl_mls_part_list_1_a on tbl_mls_part_list_1 (a);
insert into tbl_mls_part_list select   generate_series(1, 1000), 1;
create index idx_tbl_mls_part_list_1_b on tbl_mls_part_list_1 (b);
checkpoint;
--explain select * from tbl_mls_part_list where a = 999 and b = 1 order by a limit 10 ;
select * from tbl_mls_part_list where a = 999 and b = 1  order by a limit 10 ;
  a  | b 
-----+---
 999 | 1
 999 | 1
(2 rows)

\c - godlike
create table tbl_complex_guomin_333(i int, x text, j smallint, y varchar, k bigint, z text, o text, t timestamp, f4 float4, f8 float8, n1 numeric, var2 varchar, c1 char, c2 char(3)) distribute by shard(i);
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_complex_guomin_333', 4); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

\c - godlike
insert into tbl_complex_guomin_333 select generate_series(1, 10000), 'xyz', 4499, 'abcdefg', 8877, 'this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc', 'rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~', '2018-08-08 8:8:8', 111.11, 1234567890.123, 987654321.123, 'this is a varchar2 string', 'p', 'dp';
checkpoint;
select * from tbl_complex_guomin_333 where i > 9990 order by i;
   i   |  x  |  j   |    y    |  k   |                                                                                                  z                                                                                                  |                                                                                                       o                                                                                                        |            t             |   f4   |       f8       |      n1       |           var2            | c1 | c2  
-------+-----+------+---------+------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------+--------+----------------+---------------+---------------------------+----+-----
  9991 | xyz | 4499 | abcdefg | 8877 | this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc | rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
  9992 | xyz | 4499 | abcdefg | 8877 | this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc | rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
  9993 | xyz | 4499 | abcdefg | 8877 | this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc | rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
  9994 | xyz | 4499 | abcdefg | 8877 | this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc | rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
  9995 | xyz | 4499 | abcdefg | 8877 | this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc | rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
  9996 | xyz | 4499 | abcdefg | 8877 | this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc | rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
  9997 | xyz | 4499 | abcdefg | 8877 | this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc | rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
  9998 | xyz | 4499 | abcdefg | 8877 | this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc | rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
  9999 | xyz | 4499 | abcdefg | 8877 | this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc | rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
 10000 | xyz | 4499 | abcdefg | 8877 | this is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blancthis is blanc | rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~rock and rooo~~ and rooo~~rock and rooo~~ | Wed Aug 08 08:08:08 2018 | 111.11 | 1234567890.123 | 987654321.123 | this is a varchar2 string | p  | dp 
(10 rows)

truncate tbl_complex_guomin_333;
--case: schema crypt
\c - godlike
create schema crypt_schema_5;
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_SCHEMA('crypt_schema_5', 4);
 mls_transparent_crypt_algorithm_bind_schema 
---------------------------------------------
 t
(1 row)

\c - godlike
create table crypt_schema_5.tbl_crypt_5(id int, number int) distribute by shard(id);
create index idx_tbl_crypt_5_id on crypt_schema_5.tbl_crypt_5(id);
insert into crypt_schema_5.tbl_crypt_5 select generate_series(1, 100), 1024;
create table crypt_schema_5.tbl_crypt_6(id int, number int) distribute by shard(id);
create index idx_tbl_crypt_6_id on crypt_schema_5.tbl_crypt_6(id);
insert into crypt_schema_5.tbl_crypt_6 select generate_series(1, 100), 1024;
checkpoint;
select * from crypt_schema_5.tbl_crypt_5 where id < 5 order by id;
 id | number 
----+--------
  1 |   1024
  2 |   1024
  3 |   1024
  4 |   1024
(4 rows)

truncate crypt_schema_5.tbl_crypt_5;
truncate crypt_schema_5.tbl_crypt_6;
--ok, table in crypted schema could be moved to other place.
alter table crypt_schema_5.tbl_crypt_6 set schema public;
\c - godlike 
--sucess, index could be drop directly.
drop index public.idx_tbl_crypt_6_id;
--success, even mls_admin dose not unbind tbl_crypt_5
drop table crypt_schema_5.tbl_crypt_5;
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_crypt_6'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

\c - godlike
--sucess, after unbound
drop table public.tbl_crypt_6;
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_SCHEMA('crypt_schema_5');
 mls_transparent_crypt_algorithm_unbind_schema 
-----------------------------------------------
 t
(1 row)

\c - godlike
drop schema crypt_schema_5;
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex_guomin_333'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

--select MLS_TRANSPARENT_CRYPT_DROP_ALGORITHM(4);
--case set, for schema test
\c - godlike 
create schema crypt_schema_sm4;
create table crypt_schema_sm4.tbl_yy(i int, j int) distribute by shard(i);
create table tbl_zz ( i int, j int) distribute by shard(i);
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_SCHEMA('crypt_schema_sm4', 4);
 mls_transparent_crypt_algorithm_bind_schema 
---------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname in( 'tbl_zz' ,'tbl_yy') order by tblname;
 tblname | attnum | algorithm_id 
---------+--------+--------------
(0 rows)

\c - godlike
--ok
--to test policy record deleted cascaded when table dropped
create table crypt_schema_sm4.tbl_mls_part_list( a int ,b int ) PARTITION BY LIST (b) ;
CREATE TABLE crypt_schema_sm4.tbl_mls_part_list_1 PARTITION OF crypt_schema_sm4.tbl_mls_part_list FOR VALUES IN (1);
create table crypt_schema_sm4.tbl_mls_test(f1 int, f2 timestamp default now(), f3 int) 
partition by range (f2) 
    begin (timestamp without time zone '2018-01-01 0:0:0') step (interval '1 month') 
    partitions (3) 
    distribute by shard(f1) 
to group default_group ; 
alter table crypt_schema_sm4.tbl_mls_test add partitions 1;
--ok, crypt_schema_sm4.tbl_yy is not crypted
alter table crypt_schema_sm4.tbl_yy set schema public ;
--ok, tbl_zz is not crypted
alter table tbl_zz set schema crypt_schema_sm4;
--ok
create table crypt_schema_sm4.tbl_nn(i int, j int) distribute by shard(i);
\c - mls_admin
select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname = 'tbl_nn';
 tblname | attnum | algorithm_id 
---------+--------+--------------
 tbl_nn  | -32767 |            4
(1 row)

\c - godlike
--ok, crypt_schema_sm4 and crypt_schema_sm4.tbl_nn has crypted
alter table crypt_schema_sm4.tbl_nn set schema public;
\c - mls_admin
select nspname, tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map order by 1,2,3;
     nspname      |       tblname       | attnum | algorithm_id 
------------------+---------------------+--------+--------------
 crypt_schema_sm4 | tbl_mls_part_list   | -32767 |            4
 crypt_schema_sm4 | tbl_mls_part_list_1 | -32767 |            4
 crypt_schema_sm4 | tbl_mls_test        | -32767 |            4
 crypt_schema_sm4 | tbl_mls_test_part_0 | -32767 |            4
 crypt_schema_sm4 | tbl_mls_test_part_1 | -32767 |            4
 crypt_schema_sm4 | tbl_mls_test_part_2 | -32767 |            4
 crypt_schema_sm4 | tbl_mls_test_part_3 | -32767 |            4
 public           | tbl_complex         | -32767 |            1
 public           | tbl_complex         |      2 |            2
 public           | tbl_complex         |      3 |            3
 public           | tbl_complex         |      4 |            1
 public           | tbl_complex         |      5 |            2
 public           | tbl_complex         |      6 |            3
 public           | tbl_complex         |      7 |            1
 public           | tbl_complex         |      8 |            2
 public           | tbl_complex         |      9 |            3
 public           | tbl_complex         |     10 |            1
 public           | tbl_complex         |     11 |            2
 public           | tbl_complex         |     12 |            3
 public           | tbl_complex         |     13 |            1
 public           | tbl_complex         |     14 |            2
 public           | tbl_mls_part_list   | -32767 |            2
 public           | tbl_mls_part_list_1 | -32767 |            2
 public           | tbl_mls_part_list_2 | -32767 |            2
 public           | tbl_mls_part_list_3 | -32767 |            2
 public           | tbl_mls_part_list_4 | -32767 |            2
 public           | tbl_mls_test        | -32767 |            1
 public           | tbl_nn              | -32767 |            4
 public           | xx                  |      8 |            1
 public           | xx                  |     10 |            3
(30 rows)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_nn'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

--ok 
\c - godlike
drop table public.tbl_yy, public.tbl_nn, crypt_schema_sm4.tbl_zz, crypt_schema_sm4.tbl_mls_test, crypt_schema_sm4.tbl_mls_part_list, crypt_schema_sm4.tbl_mls_part_list_1;
\c - mls_admin
--policies record should be deleted
select nspname, tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map  order by 1,2,3;
 nspname |       tblname       | attnum | algorithm_id 
---------+---------------------+--------+--------------
 public  | tbl_complex         | -32767 |            1
 public  | tbl_complex         |      2 |            2
 public  | tbl_complex         |      3 |            3
 public  | tbl_complex         |      4 |            1
 public  | tbl_complex         |      5 |            2
 public  | tbl_complex         |      6 |            3
 public  | tbl_complex         |      7 |            1
 public  | tbl_complex         |      8 |            2
 public  | tbl_complex         |      9 |            3
 public  | tbl_complex         |     10 |            1
 public  | tbl_complex         |     11 |            2
 public  | tbl_complex         |     12 |            3
 public  | tbl_complex         |     13 |            1
 public  | tbl_complex         |     14 |            2
 public  | tbl_mls_part_list   | -32767 |            2
 public  | tbl_mls_part_list_1 | -32767 |            2
 public  | tbl_mls_part_list_2 | -32767 |            2
 public  | tbl_mls_part_list_3 | -32767 |            2
 public  | tbl_mls_part_list_4 | -32767 |            2
 public  | tbl_mls_test        | -32767 |            1
 public  | xx                  |      8 |            1
 public  | xx                  |     10 |            3
(22 rows)

\c - godlike
--fail, crypt_schema_sm4 is not empty
alter schema crypt_schema_sm4 rename to crypt_schema_sm5;
ERROR:  could not rename schema:crypt_schema_sm4, cause there are tables having mls poilcy bound in this schema
drop schema crypt_schema_sm4;
ERROR:  could not drop schema, cause there are tables having crypt poilcy bound in this schema or schema has crypt bound
--unbind schema
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_SCHEMA('crypt_schema_sm4');
 mls_transparent_crypt_algorithm_unbind_schema 
-----------------------------------------------
 t
(1 row)

\c - godlike
alter schema crypt_schema_sm4 rename to crypt_schema_sm5;
drop schema crypt_schema_sm5;
--case rename tables in crypted schema
\c - godlike 
create schema crypt_schema_sm66;
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_SCHEMA('crypt_schema_sm66', 4);
 mls_transparent_crypt_algorithm_bind_schema 
---------------------------------------------
 t
(1 row)

\c - godlike
create table crypt_schema_sm66.tbl_mls_part_list( a int ,b int ) PARTITION BY LIST (b) ;
CREATE TABLE crypt_schema_sm66.tbl_mls_part_list_1 PARTITION OF crypt_schema_sm66.tbl_mls_part_list FOR VALUES IN (1);
alter table crypt_schema_sm66.tbl_mls_part_list rename to tbl_mls_part_list_rename;
\c - mls_admin
--expect crypt_schema_sm66.tbl_mls_part_list was renamed.
select nspname, tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map  order by 1,2,3;
      nspname      |         tblname          | attnum | algorithm_id 
-------------------+--------------------------+--------+--------------
 crypt_schema_sm66 | tbl_mls_part_list_1      | -32767 |            4
 crypt_schema_sm66 | tbl_mls_part_list_rename | -32767 |            4
 public            | tbl_complex              | -32767 |            1
 public            | tbl_complex              |      2 |            2
 public            | tbl_complex              |      3 |            3
 public            | tbl_complex              |      4 |            1
 public            | tbl_complex              |      5 |            2
 public            | tbl_complex              |      6 |            3
 public            | tbl_complex              |      7 |            1
 public            | tbl_complex              |      8 |            2
 public            | tbl_complex              |      9 |            3
 public            | tbl_complex              |     10 |            1
 public            | tbl_complex              |     11 |            2
 public            | tbl_complex              |     12 |            3
 public            | tbl_complex              |     13 |            1
 public            | tbl_complex              |     14 |            2
 public            | tbl_mls_part_list        | -32767 |            2
 public            | tbl_mls_part_list_1      | -32767 |            2
 public            | tbl_mls_part_list_2      | -32767 |            2
 public            | tbl_mls_part_list_3      | -32767 |            2
 public            | tbl_mls_part_list_4      | -32767 |            2
 public            | tbl_mls_test             | -32767 |            1
 public            | xx                       |      8 |            1
 public            | xx                       |     10 |            3
(24 rows)

\c - godlike
create table crypt_schema_sm66.tbl_mls_test(f1 int, f2 timestamp default now(), f3 int) 
partition by range (f2) 
    begin (timestamp without time zone '2018-01-01 0:0:0') step (interval '1 month') 
    partitions (3) 
    distribute by shard(f1) 
to group default_group ; 
--fail: could not rename interval partition or its index
alter table crypt_schema_sm66.tbl_mls_test rename to tbl_mls_test_rename;
ERROR:  could not rename interval partition or its index
\c - godlike
select relname from pg_class c, pg_namespace n where c.relnamespace = n.oid and n.nspname = 'crypt_schema_sm66' order by 1;
         relname          
--------------------------
 tbl_mls_part_list_1
 tbl_mls_part_list_rename
 tbl_mls_test
 tbl_mls_test_part_0
 tbl_mls_test_part_1
 tbl_mls_test_part_2
(6 rows)

drop table crypt_schema_sm66.tbl_mls_part_list_rename, crypt_schema_sm66.tbl_mls_part_list_1, crypt_schema_sm66.tbl_mls_test;
select relname from pg_class c, pg_namespace n where c.relnamespace = n.oid and n.nspname = 'crypt_schema_sm66' order by 1;
 relname 
---------
(0 rows)

\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_SCHEMA('crypt_schema_sm66');
 mls_transparent_crypt_algorithm_unbind_schema 
-----------------------------------------------
 t
(1 row)

\c - godlike
drop schema crypt_schema_sm66;
--case set, for orignal partition tables
--case1, parent and child L1 was created, bind crypt policy to parent
\c - godlike
create table order_range_list(id bigserial not null,userid integer,product text,area text, createdate date) partition by list ( area );
create table order_range_list_gd partition of order_range_list for values in ('guangdong') partition by range(createdate); 
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

--1.1 both of them would be bound.
select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
       tblname       | attnum | algorithm_id 
---------------------+--------+--------------
 order_range_list    | -32767 |            1
 order_range_list_gd | -32767 |            1
(2 rows)

--1.2 while, create L2 child, L2 child dose not have policy.
\c - godlike 
create table order_range_list_gd_201701 partition of order_range_list_gd(id primary key,userid,product,area,createdate) for values from ('2017-01-01') to ('2017-02-01'); 
\c - mls_admin
select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
       tblname       | attnum | algorithm_id 
---------------------+--------+--------------
 order_range_list    | -32767 |            1
 order_range_list_gd | -32767 |            1
(2 rows)

--1.3 attach a noncrypt child, there would be not crypted bound to it.
\c - godlike
create table order_range_list_bj(id bigserial not null,userid integer,product text,area text, createdate date) partition by range(createdate); 
alter table order_range_list attach partition order_range_list_bj for values in ('beijing'); 
\c - mls_admin
select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
       tblname       | attnum | algorithm_id 
---------------------+--------+--------------
 order_range_list    | -32767 |            1
 order_range_list_gd | -32767 |            1
(2 rows)

--1.4 attach a crypted child, it would keep its own crypt policy.
\c - godlike
create table order_range_list_sh(id bigserial not null,userid integer,product text,area text, createdate date) partition by range(createdate); 
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list_sh', 2); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
       tblname       | attnum | algorithm_id 
---------------------+--------+--------------
 order_range_list    | -32767 |            1
 order_range_list_gd | -32767 |            1
 order_range_list_sh | -32767 |            2
(3 rows)

\c - godlike
alter table order_range_list attach partition order_range_list_sh for values in ('shanghai'); 
\c - mls_admin
select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
       tblname       | attnum | algorithm_id 
---------------------+--------+--------------
 order_range_list    | -32767 |            1
 order_range_list_gd | -32767 |            1
 order_range_list_sh | -32767 |            2
(3 rows)

--1.5 detach the non crypt child, ok
\c - godlike
alter table order_range_list detach partition order_range_list_bj;
--1.6 detach the crypted child, while admin is forbidden to do this, mls_admin has the right.
\c - godlike
alter table order_range_list detach partition order_range_list_sh;
ERROR:  could not detach partition for table:order_range_list, cause mls poilcy is bound
\c - mls_admin
alter table order_range_list detach partition order_range_list_sh;
--1.7 mls_admin could not detach uncrypt child, bj is noncrypt
\c - godlike
alter table order_range_list attach partition order_range_list_bj for values in ('beijing') ;
\c - mls_admin
alter table order_range_list detach partition order_range_list_bj;
ERROR:  must be owner of relation order_range_list
--1.8 mls_admin could not attach child, no matter crypt or noncrypt
\c - mls_admin
alter table order_range_list attach partition order_range_list_bj for values in ('beijing') ;
ERROR:  must be owner of relation order_range_list
alter table order_range_list attach partition order_range_list_sh for values in ('shanghai') ;
ERROR:  must be owner of relation order_range_list
\c - godlike
alter table order_range_list attach partition order_range_list_sh for values in ('shanghai') ;
--1.9 L2 child has crypt bound, root parent would get error
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_bj'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_sh'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
 tblname | attnum | algorithm_id 
---------+--------+--------------
(0 rows)

--bind L2
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list_gd_201701', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
          tblname           | attnum | algorithm_id 
----------------------------+--------+--------------
 order_range_list_gd_201701 | -32767 |            1
(1 row)

--bind root parent error
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list', 1); 
ERROR:  table:public.order_range_list_gd_201701 has attnum:-32767 bound crypt policy, algo_id:1
CONTEXT:  PL/pgSQL function mls_transparent_crypt_algorithm_bind_table(name,name,integer) line 73 at RAISE
select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
          tblname           | attnum | algorithm_id 
----------------------------+--------+--------------
 order_range_list_gd_201701 | -32767 |            1
(1 row)

--clear
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list', true); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
 tblname | attnum | algorithm_id 
---------+--------+--------------
(0 rows)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701', true); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
 tblname | attnum | algorithm_id 
---------+--------+--------------
(0 rows)

--1.10 root parent bind crypt, its children would be bound too.
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
          tblname           | attnum | algorithm_id 
----------------------------+--------+--------------
 order_range_list           | -32767 |            1
 order_range_list_bj        | -32767 |            1
 order_range_list_gd        | -32767 |            1
 order_range_list_gd_201701 | -32767 |            1
 order_range_list_sh        | -32767 |            1
(5 rows)

--clear
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_bj'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_sh'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by 1,2,3;
 tblname | attnum | algorithm_id 
---------+--------+--------------
(0 rows)

--1.11 root parent bind column crypt, its children would be bound too. And column is bound seperately.
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list_gd_201701', 'userid', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by 1,2,3;
          tblname           | attnum | algorithm_id 
----------------------------+--------+--------------
 order_range_list_gd_201701 |      2 |            1
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list_gd_201701', 'product', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by 1,2,3;
          tblname           | attnum | algorithm_id 
----------------------------+--------+--------------
 order_range_list_gd_201701 |      2 |            1
 order_range_list_gd_201701 |      3 |            1
(2 rows)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_bj'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_sh'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701', 'product'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701', 'userid'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

--1.12 file crypt and column crypt can not affect with each other.
--1.12.1
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list_gd_201701', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list_gd_201701', 'userid', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list_gd_201701', 'product', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
          tblname           | attnum | algorithm_id 
----------------------------+--------+--------------
 order_range_list_gd_201701 | -32767 |            1
 order_range_list_gd_201701 |      2 |            1
 order_range_list_gd_201701 |      3 |            1
(3 rows)

--clean
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701','userid'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701','product'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

--1.12.2
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list_gd_201701', 'userid', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list_gd_201701', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'order_range_list_gd_201701', 'product', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
          tblname           | attnum | algorithm_id 
----------------------------+--------+--------------
 order_range_list_gd_201701 |      2 |            1
 order_range_list_gd_201701 | -32767 |            1
 order_range_list_gd_201701 |      3 |            1
(3 rows)

--clean
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701','userid'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701','product'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

--clear case 1
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_bj'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_sh'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'order_range_list_gd_201701'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'order_range_list%' order by tblname;
 tblname | attnum | algorithm_id 
---------+--------+--------------
(0 rows)

\c - godlike
drop table order_range_list;
--case2 parent and child have no crypt policy, bind crypt to the child, parent would not bound with crypt.
\c - godlike
CREATE TABLE tbl_opentenbase (
    f1 bigint,
    f2 text
)
PARTITION BY RANGE (f1)
DISTRIBUTE BY SHARD (f1) to GROUP default_group;
CREATE TABLE tbl_opentenbase_1 PARTITION OF tbl_opentenbase FOR VALUES FROM (1) TO (10000000);
\c - mls_admin 
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_opentenbase_1', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'tbl_opentenbase%' order by tblname;
   tblname   | attnum | algorithm_id 
-------------+--------+--------------
 tbl_opentenbase_1 | -32767 |            1
(1 row)

--case2.1 bind parent crypt would fail
\c - mls_admin 
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_opentenbase', 1); 
ERROR:  table:public.tbl_opentenbase_1 has attnum:-32767 bound crypt policy, algo_id:1
CONTEXT:  PL/pgSQL function mls_transparent_crypt_algorithm_bind_table(name,name,integer) line 73 at RAISE
--case2.2 detach the child by mls_admin, bind parent crypt policy, then attach this crypt child 
\c - mls_admin 
alter table tbl_opentenbase detach partition tbl_opentenbase_1;
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_opentenbase', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'tbl_opentenbase%' order by tblname;
   tblname   | attnum | algorithm_id 
-------------+--------+--------------
 tbl_opentenbase   | -32767 |            1
 tbl_opentenbase_1 | -32767 |            1
(2 rows)

\c - godlike
alter table tbl_opentenbase attach partition tbl_opentenbase_1 FOR VALUES FROM (1) TO (10000000);
--clean case2
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_opentenbase'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_opentenbase_1'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'tbl_opentenbase%' order by tblname;
 tblname | attnum | algorithm_id 
---------+--------+--------------
(0 rows)

\c - godlike
drop table tbl_opentenbase;
--case3 parent has no crypt, but child has. drop table would fail
\c - godlike
CREATE TABLE tbl_opentenbase (
    f1 bigint,
    f2 text
)
PARTITION BY RANGE (f1)
DISTRIBUTE BY SHARD (f1) to GROUP default_group;
CREATE TABLE tbl_opentenbase_1 PARTITION OF tbl_opentenbase FOR VALUES FROM (1) TO (10000000);
\c - mls_admin 
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_opentenbase_1', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'tbl_opentenbase%' order by tblname;
   tblname   | attnum | algorithm_id 
-------------+--------+--------------
 tbl_opentenbase_1 | -32767 |            1
(1 row)

\c - godlike
drop table tbl_opentenbase;
ERROR:  could not drop table:tbl_opentenbase, cause mls poilcy is bound
--case3.1 detach the crypt child, drop ok
\c - mls_admin 
alter table tbl_opentenbase detach partition tbl_opentenbase_1;
\c - godlike
drop table tbl_opentenbase;
--case3.2 unbind crypt, drop ok
\c - godlike
CREATE TABLE tbl_opentenbase (
    f1 bigint,
    f2 text
)
PARTITION BY RANGE (f1)
DISTRIBUTE BY SHARD (f1) to GROUP default_group;
alter table tbl_opentenbase attach partition tbl_opentenbase_1 FOR VALUES FROM (1) TO (10000000);
\c - mls_admin 
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_opentenbase_1'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'tbl_opentenbase%' order by tblname;
 tblname | attnum | algorithm_id 
---------+--------+--------------
(0 rows)

\c - godlike
drop table tbl_opentenbase;
--case4 unbind crypt would not be cascaded, parent is empty, crypt could be dropped
\c - godlike
CREATE TABLE tbl_opentenbase (
    f1 bigint,
    f2 text
)
PARTITION BY RANGE (f1)
DISTRIBUTE BY SHARD (f1) to GROUP default_group;
CREATE TABLE tbl_opentenbase_1 PARTITION OF tbl_opentenbase FOR VALUES FROM (1) TO (10000000);
\c - mls_admin 
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('public', 'tbl_opentenbase', 1); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'tbl_opentenbase%' order by tblname;
   tblname   | attnum | algorithm_id 
-------------+--------+--------------
 tbl_opentenbase   | -32767 |            1
 tbl_opentenbase_1 | -32767 |            1
(2 rows)

--case4.1 crypt could be dropped on child if child is empty.
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_opentenbase'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'tbl_opentenbase%' order by tblname;
   tblname   | attnum | algorithm_id 
-------------+--------+--------------
 tbl_opentenbase_1 | -32767 |            1
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_opentenbase_1'); 
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select tblname, attnum, algorithm_id from pg_transparent_crypt_policy_map where tblname ilike 'tbl_opentenbase%' order by tblname;
 tblname | attnum | algorithm_id 
---------+--------+--------------
(0 rows)

--clean case4
\c - godlike
drop table tbl_opentenbase;
--case 5 materialized view
\c - godlike 
create schema crypt_schema_materializedview_single;
\c - mls_admin 
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_SCHEMA('crypt_schema_materializedview_single', 4);
 mls_transparent_crypt_algorithm_bind_schema 
---------------------------------------------
 t
(1 row)

\c - godlike 
create table crypt_schema_materializedview_single.crypt_schema_materializedview_single(f1 int, f2 int2, f3 int4, f4 int8, f5 varchar, f6 text, f7 char(20), f8 varchar, f9 numeric, f10 timestamp, f11 float4, f12 float8);
create materialized view crypt_schema_materializedview_single.crypt_schema_materializedview_single_v as select f1,f2,f5,f10 from crypt_schema_materializedview_single.crypt_schema_materializedview_single ;
\c - mls_admin
select attnum,algorithm_id,spcoid,spcname,nspname,tblname from pg_transparent_crypt_policy_map where tblname ilike 'crypt_schema_materializedview_single%';
 attnum | algorithm_id | spcoid |  spcname   |               nspname                |                tblname                 
--------+--------------+--------+------------+--------------------------------------+----------------------------------------
 -32767 |            4 |   1663 | pg_default | crypt_schema_materializedview_single | crypt_schema_materializedview_single
 -32767 |            4 |   1663 | pg_default | crypt_schema_materializedview_single | crypt_schema_materializedview_single_v
(2 rows)

\c - godlike
drop materialized view crypt_schema_materializedview_single.crypt_schema_materializedview_single_v ;
drop table crypt_schema_materializedview_single.crypt_schema_materializedview_single ;
--materialized view should be clean
\c - mls_admin
select attnum,algorithm_id,spcoid,spcname,nspname,tblname from pg_transparent_crypt_policy_map where tblname ilike 'crypt_schema_materializedview_single%';
 attnum | algorithm_id | spcoid | spcname | nspname | tblname 
--------+--------------+--------+---------+---------+---------
(0 rows)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_SCHEMA('crypt_schema_materializedview_single');
 mls_transparent_crypt_algorithm_unbind_schema 
-----------------------------------------------
 t
(1 row)

--case 6 orignal partition delete cascaded
\c - godlike 
create schema crypt_schema_partition_range;
\c - mls_admin 
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_SCHEMA('crypt_schema_partition_range', 4);
 mls_transparent_crypt_algorithm_bind_schema 
---------------------------------------------
 t
(1 row)

\c - godlike
create table crypt_schema_partition_range.crypt_schema_partition_range(f1 int, f2 int2, f3 int4, f4 int8, f5 varchar, f6 text, f7 char(20), f8 varchar, f9 numeric, f10 timestamp, f11 float4, f12 float8) partition by list (f6);
drop table if exists crypt_schema_partition_range.crypt_schema_partition_range_bj;
NOTICE:  table "crypt_schema_partition_range_bj" does not exist, skipping
create table crypt_schema_partition_range.crypt_schema_partition_range_bj(f1 int, f2 int2, f3 int4, f4 int8, f5 varchar, f6 text, f7 char(20), f8 varchar, f9 numeric, f10 timestamp, f11 float4, f12 float8) partition by range (f10);
drop table if exists crypt_schema_partition_range.crypt_schema_partition_range_gd_201702;
NOTICE:  table "crypt_schema_partition_range_gd_201702" does not exist, skipping
create table crypt_schema_partition_range.crypt_schema_partition_range_gd_201702(f1 int, f2 int2, f3 int4, f4 int8, f5 varchar, f6 text, f7 char(20), f8 varchar, f9 numeric, f10 timestamp, f11 float4, f12 float8);
drop table if exists crypt_schema_partition_range.crypt_schema_partition_range_bj_201702;
NOTICE:  table "crypt_schema_partition_range_bj_201702" does not exist, skipping
create table crypt_schema_partition_range.crypt_schema_partition_range_bj_201702(f1 int, f2 int2, f3 int4, f4 int8, f5 varchar, f6 text, f7 char(20), f8 varchar, f9 numeric, f10 timestamp, f11 float4, f12 float8);
-- create first level sub partition
create table crypt_schema_partition_range.crypt_schema_partition_range_gd partition of crypt_schema_partition_range.crypt_schema_partition_range for values in ('guangdong') partition by range (f10);
-- attach first level sub partition
alter table crypt_schema_partition_range.crypt_schema_partition_range attach partition crypt_schema_partition_range.crypt_schema_partition_range_bj for values in ('beijing');
-- create second level sub partition
create table crypt_schema_partition_range.crypt_schema_partition_range_gd_201701 partition of crypt_schema_partition_range.crypt_schema_partition_range_gd(f1 primary key,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) for values from ('2017-01-01') to ('2017-02-01'); 
create table crypt_schema_partition_range.crypt_schema_partition_range_bj_201701 partition of crypt_schema_partition_range.crypt_schema_partition_range_bj(f1 primary key,f2,f3,f4,f5,f6,f7,f8,f9,f10,f11,f12) for values from ('2017-01-01') to ('2017-02-01');
-- attach second level sub partition
alter table crypt_schema_partition_range.crypt_schema_partition_range_bj attach partition crypt_schema_partition_range.crypt_schema_partition_range_bj_201702 for values from ('2017-02-01') to ('2017-03-01');
alter table crypt_schema_partition_range.crypt_schema_partition_range_gd attach partition crypt_schema_partition_range.crypt_schema_partition_range_gd_201702 for values from ('2017-02-01') to ('2017-03-01');
-- 
\c - mls_admin 
select attnum,algorithm_id,spcoid,spcname,nspname,tblname from pg_transparent_crypt_policy_map where tblname ilike 'crypt_schema_partition_range%' order by tblname asc;
 attnum | algorithm_id | spcoid |  spcname   |           nspname            |                tblname                 
--------+--------------+--------+------------+------------------------------+----------------------------------------
 -32767 |            4 |   1663 | pg_default | crypt_schema_partition_range | crypt_schema_partition_range
 -32767 |            4 |   1663 | pg_default | crypt_schema_partition_range | crypt_schema_partition_range_bj
 -32767 |            4 |   1663 | pg_default | crypt_schema_partition_range | crypt_schema_partition_range_bj_201701
 -32767 |            4 |   1663 | pg_default | crypt_schema_partition_range | crypt_schema_partition_range_bj_201702
 -32767 |            4 |   1663 | pg_default | crypt_schema_partition_range | crypt_schema_partition_range_gd
 -32767 |            4 |   1663 | pg_default | crypt_schema_partition_range | crypt_schema_partition_range_gd_201701
 -32767 |            4 |   1663 | pg_default | crypt_schema_partition_range | crypt_schema_partition_range_gd_201702
(7 rows)

\c - godlike
drop table crypt_schema_partition_range.crypt_schema_partition_range ;
-- there shoule be nothing left
\c - mls_admin 
select attnum,algorithm_id,spcoid,spcname,nspname,tblname from pg_transparent_crypt_policy_map where tblname ilike 'crypt_schema_partition_range%' order by tblname asc;
 attnum | algorithm_id | spcoid | spcname | nspname | tblname 
--------+--------------+--------+---------+---------+---------
(0 rows)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_SCHEMA('crypt_schema_partition_range');
 mls_transparent_crypt_algorithm_unbind_schema 
-----------------------------------------------
 t
(1 row)

--case 7 schema pg_toast with crypt 
\c - mls_admin 
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_SCHEMA('pg_toast', 4);
 mls_transparent_crypt_algorithm_bind_schema 
---------------------------------------------
 t
(1 row)

\c - godlike
create table crypt_default_schema(f1 int, f2 int2, f3 int4, f4 int8, f5 varchar, f6 text, f7 char(20), f8 varchar, f9 numeric, f10 timestamp, f11 float4, f12 float8) distribute by replication;
\c - mls_admin 
select attnum,algorithm_id,spcoid,spcname,nspname from pg_transparent_crypt_policy_map where nspname ilike 'pg_toast%' order by tblname asc;
 attnum | algorithm_id | spcoid |  spcname   | nspname  
--------+--------------+--------+------------+----------
 -32767 |            4 |   1663 | pg_default | pg_toast
(1 row)

\c - godlike
drop table crypt_default_schema ;
--there shoule be no crypt storage in pg_toast schema 
\c - mls_admin 
select attnum,algorithm_id,spcoid,spcname,nspname from pg_transparent_crypt_policy_map where nspname ilike 'pg_toast%' order by tblname asc;
 attnum | algorithm_id | spcoid | spcname | nspname 
--------+--------------+--------+---------+---------
(0 rows)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_SCHEMA('pg_toast');
 mls_transparent_crypt_algorithm_unbind_schema 
-----------------------------------------------
 t
(1 row)

--end--------------------------------------------------------------
--------------------------test block:alter table schema begin--------------------------
--  | case id | table crypted | src schema crypted | dst schema crypted | result |
--  | case1   | yes           | no                 | yes/no             | fail   |
--  | case2   | yes           | yes                | yes/no             | ok     |
--  | case3   | no            | yes                | yes/no             | ok     |
--  | case4   | no            | no                 | yes/no             | ok     |
--  
\c - godlike 
create schema no_crypted_schema_alt;
create schema no_crypted_schema_alt_2;
create schema crypted_schema_alt;
create schema crypted_schema_alt_2;
create table no_crypted_schema_alt.tbl_crypted_alt(f1 int, f2 timestamp default now(), f3 int) 
partition by range (f2) 
    begin (timestamp without time zone '2018-01-01 0:0:0') step (interval '1 month') 
    partitions (3) 
    distribute by shard(f1) 
to group default_group ; 
create table no_crypted_schema_alt.tbl_nocrypt_alt(f1 int, f2 timestamp default now(), f3 int) 
partition by range (f2) 
    begin (timestamp without time zone '2018-01-01 0:0:0') step (interval '1 month') 
    partitions (3) 
    distribute by shard(f1) 
to group default_group ;
create table crypted_schema_alt.tbl_nocrypt_alt_2(f1 int, f2 timestamp default now(), f3 int) 
partition by range (f2) 
    begin (timestamp without time zone '2018-01-01 0:0:0') step (interval '1 month') 
    partitions (3) 
    distribute by shard(f1) 
to group default_group ;
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_TABLE('no_crypted_schema_alt', 'tbl_crypted_alt', 4); 
 mls_transparent_crypt_algorithm_bind_table 
--------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_SCHEMA('crypted_schema_alt', 4);
 mls_transparent_crypt_algorithm_bind_schema 
---------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_BIND_SCHEMA('crypted_schema_alt_2', 4);
 mls_transparent_crypt_algorithm_bind_schema 
---------------------------------------------
 t
(1 row)

\c - godlike 
create table crypted_schema_alt.tbl_crypt_alt_2(f1 int, f2 timestamp default now(), f3 int) 
partition by range (f2) 
    begin (timestamp without time zone '2018-01-01 0:0:0') step (interval '1 month') 
    partitions (3) 
    distribute by shard(f1) 
to group default_group ; 
\c - mls_admin
select algorithm_id, nspname, tblname from pg_transparent_crypt_policy_map where nspname ilike '%alt%' order by 1,2,3;
 algorithm_id |        nspname        |        tblname         
--------------+-----------------------+------------------------
            4 | crypted_schema_alt    | tbl_crypt_alt_2
            4 | crypted_schema_alt    | tbl_crypt_alt_2_part_0
            4 | crypted_schema_alt    | tbl_crypt_alt_2_part_1
            4 | crypted_schema_alt    | tbl_crypt_alt_2_part_2
            4 | no_crypted_schema_alt | tbl_crypted_alt
(5 rows)

--case 1 | case1   | yes           | no                 | yes/no             | fail   |  
\c - godlike
--fail 
alter table no_crypted_schema_alt.tbl_crypted_alt set schema no_crypted_schema_alt_2;
ERROR:  could not alter table:tbl_crypted_alt schema, cause mls poilcy is bound
alter table no_crypted_schema_alt.tbl_crypted_alt set schema crypted_schema_alt;
ERROR:  could not alter table:tbl_crypted_alt schema, cause mls poilcy is bound
--case 2 | case2   | yes           | yes                | yes/no             | ok     |
--ok 
\c - godlike 
alter table crypted_schema_alt.tbl_crypt_alt_2 set schema crypted_schema_alt_2;
\c - mls_admin
select algorithm_id, nspname, tblname from pg_transparent_crypt_policy_map where nspname ilike '%alt%' order by 1,2,3;
 algorithm_id |        nspname        |        tblname         
--------------+-----------------------+------------------------
            4 | crypted_schema_alt_2  | tbl_crypt_alt_2
            4 | crypted_schema_alt_2  | tbl_crypt_alt_2_part_0
            4 | crypted_schema_alt_2  | tbl_crypt_alt_2_part_1
            4 | crypted_schema_alt_2  | tbl_crypt_alt_2_part_2
            4 | no_crypted_schema_alt | tbl_crypted_alt
(5 rows)

\c - godlike 
alter table crypted_schema_alt_2.tbl_crypt_alt_2 set schema crypted_schema_alt;
\c - mls_admin
select algorithm_id, nspname, tblname from pg_transparent_crypt_policy_map where nspname ilike '%alt%' order by 1,2,3;
 algorithm_id |        nspname        |        tblname         
--------------+-----------------------+------------------------
            4 | crypted_schema_alt    | tbl_crypt_alt_2
            4 | crypted_schema_alt    | tbl_crypt_alt_2_part_0
            4 | crypted_schema_alt    | tbl_crypt_alt_2_part_1
            4 | crypted_schema_alt    | tbl_crypt_alt_2_part_2
            4 | no_crypted_schema_alt | tbl_crypted_alt
(5 rows)

--ok
\c - godlike
alter table crypted_schema_alt.tbl_crypt_alt_2 set schema no_crypted_schema_alt_2;
\c - mls_admin
select algorithm_id, nspname, tblname from pg_transparent_crypt_policy_map where nspname ilike '%alt%' order by 1,2,3;
 algorithm_id |         nspname         |        tblname         
--------------+-------------------------+------------------------
            4 | no_crypted_schema_alt   | tbl_crypted_alt
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2_part_0
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2_part_1
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2_part_2
(5 rows)

\c - godlike
--while, can not move back
alter table no_crypted_schema_alt_2.tbl_crypt_alt_2 set schema crypted_schema_alt;
ERROR:  could not alter table:tbl_crypt_alt_2 schema, cause mls poilcy is bound
\c - mls_admin
select algorithm_id, nspname, tblname from pg_transparent_crypt_policy_map where nspname ilike '%alt%' order by 1,2,3;
 algorithm_id |         nspname         |        tblname         
--------------+-------------------------+------------------------
            4 | no_crypted_schema_alt   | tbl_crypted_alt
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2_part_0
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2_part_1
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2_part_2
(5 rows)

--case 3 | case3   | no            | yes                | yes/no             | ok     |
--ok 
\c - godlike 
alter table crypted_schema_alt.tbl_nocrypt_alt_2 set schema crypted_schema_alt_2;
\c - godlike 
alter table crypted_schema_alt_2.tbl_nocrypt_alt_2 set schema crypted_schema_alt;
--ok
\c - godlike
alter table crypted_schema_alt.tbl_nocrypt_alt_2 set schema no_crypted_schema_alt_2;
\c - godlike
alter table no_crypted_schema_alt_2.tbl_nocrypt_alt_2 set schema crypted_schema_alt;
--case 4 | case4   | no            | no                 | yes/no             | ok     |
--ok 
\c - godlike 
alter table crypted_schema_alt.tbl_nocrypt_alt_2 set schema crypted_schema_alt_2;
\c - godlike 
alter table crypted_schema_alt_2.tbl_nocrypt_alt_2 set schema crypted_schema_alt;
--ok
\c - godlike
alter table crypted_schema_alt.tbl_nocrypt_alt_2 set schema no_crypted_schema_alt_2;
\c - godlike
alter table no_crypted_schema_alt_2.tbl_nocrypt_alt_2 set schema crypted_schema_alt;
--clean 
\c - mls_admin
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('no_crypted_schema_alt', 'tbl_crypted_alt');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('no_crypted_schema_alt_2', 'tbl_crypt_alt_2');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_SCHEMA('crypted_schema_alt');
 mls_transparent_crypt_algorithm_unbind_schema 
-----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_SCHEMA('crypted_schema_alt_2');
 mls_transparent_crypt_algorithm_unbind_schema 
-----------------------------------------------
 t
(1 row)

-- child table has bind
select algorithm_id, nspname, tblname from pg_transparent_crypt_policy_map where nspname ilike '%alt%' order by 1,2,3;
 algorithm_id |         nspname         |        tblname         
--------------+-------------------------+------------------------
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2_part_0
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2_part_1
            4 | no_crypted_schema_alt_2 | tbl_crypt_alt_2_part_2
(3 rows)

--clean child
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('no_crypted_schema_alt_2', 'tbl_crypt_alt_2_part_0');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('no_crypted_schema_alt_2', 'tbl_crypt_alt_2_part_1');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('no_crypted_schema_alt_2', 'tbl_crypt_alt_2_part_2');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

\c - godlike
drop table no_crypted_schema_alt.tbl_crypted_alt;
drop table no_crypted_schema_alt.tbl_nocrypt_alt;
drop table crypted_schema_alt.tbl_nocrypt_alt_2;
drop table no_crypted_schema_alt_2.tbl_crypt_alt_2;
drop schema no_crypted_schema_alt;
drop schema no_crypted_schema_alt_2;
drop schema crypted_schema_alt;
drop schema crypted_schema_alt_2;
--------------------------test block:alter table schema end--------------------------
\c regression godlike
drop  table xx;
ERROR:  could not drop table:xx, cause mls poilcy is bound
drop  table yy;
drop  table zz;
drop  table tbl_complex;
ERROR:  could not drop table:tbl_complex, cause mls poilcy is bound
drop  table tbl_transparent_unsupport;
drop  table tbl_complex_guomin_333;
truncate tbl_complex;
\c - mls_admin 
select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'i');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'x');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'j');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'y');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'k');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'z');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'o');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 't');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'f4');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'f8');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'n1');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'var2');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'c1');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

select MLS_TRANSPARENT_CRYPT_ALGORITHM_UNBIND_TABLE('public', 'tbl_complex', 'c2');
 mls_transparent_crypt_algorithm_unbind_table 
----------------------------------------------
 t
(1 row)

\c - godlike
drop  table tbl_complex;
-----------------TRANSPARENT CRYPT TEST END--------------------
