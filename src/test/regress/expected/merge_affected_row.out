---TAPD:
---test exec merge update the same row more than one time
---tapd:123732935
\c regression_ora
drop table if exists m_test;
NOTICE:  table "M_TEST" does not exist, skipping
drop table if exists s_test;
NOTICE:  table "S_TEST" does not exist, skipping
create table m_test(i int, j int, k int);
create table s_test(i int, j int, k int);
insert into m_test values (1,2,3);
insert into s_test values (1,2,3);
insert into s_test values (1,3,4);
analyze m_test;
analyze s_test;
-- expected success
begin;
merge into m_test using s_test on (m_test.i=s_test.i) when matched then update set j=s_test.j, k=s_test.k;
select * from m_test order by 1;
 I | J | K 
---+---+---
 1 | 3 | 4
(1 row)

rollback;
-- expected error
begin;
insert into s_test values (1,3,4);
merge into m_test using s_test on (m_test.i=s_test.i) when matched then update set j=s_test.j, k=s_test.k;
ERROR:  MERGE command cannot affect row a second time
HINT:  Ensure that not more than one source row matches any one target row.
rollback;
select * from m_test order by 1;
 I | J | K 
---+---+---
 1 | 2 | 3
(1 row)

-- expected error
begin;
insert into s_test values (1,2,3);
merge into m_test using s_test on (m_test.i=s_test.i) when matched then update set j=s_test.j, k=s_test.k;
ERROR:  MERGE command cannot affect row a second time
HINT:  Ensure that not more than one source row matches any one target row.
rollback;
select * from m_test order by 1;
 I | J | K 
---+---+---
 1 | 2 | 3
(1 row)

drop table m_test;
drop table s_test;
